<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ç°¡å–®åŒæ­¥æ¸¬è©¦</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background: #1a1a1a;
        color: white;
      }
      .section {
        background: #2a2a2a;
        border: 2px solid #444;
        border-radius: 8px;
        padding: 20px;
        margin: 20px 0;
      }
      .section h2 {
        color: #ffff00;
        margin-top: 0;
      }
      .button {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 5px;
        cursor: pointer;
        margin: 5px;
        font-size: 14px;
      }
      .button:hover {
        background: #0056b3;
      }
      .button.success {
        background: #28a745;
      }
      .button.danger {
        background: #dc3545;
      }
      .result {
        background: #333;
        border: 1px solid #555;
        border-radius: 4px;
        padding: 15px;
        margin: 10px 0;
        font-family: monospace;
        white-space: pre-wrap;
        max-height: 300px;
        overflow-y: auto;
      }
    </style>
  </head>
  <body>
    <h1>ğŸ§ª ç°¡å–®åŒæ­¥æ¸¬è©¦</h1>

    <!-- æœ¬åœ°è¨˜éŒ„ç®¡ç† -->
    <div class="section">
      <h2>ğŸ“± æœ¬åœ°è¨˜éŒ„ç®¡ç†</h2>
      <div>
        <button class="button success" onclick="createTestLocalScores()">
          å‰µå»ºæ¸¬è©¦è¨˜éŒ„
        </button>
        <button class="button" onclick="showLocalScores()">æŸ¥çœ‹æœ¬åœ°è¨˜éŒ„</button>
        <button class="button danger" onclick="clearLocalScores()">
          æ¸…é™¤æœ¬åœ°è¨˜éŒ„
        </button>
      </div>
      <div id="localResult" class="result"></div>
    </div>

    <!-- èªè­‰ç‹€æ…‹ç®¡ç† -->
    <div class="section">
      <h2>ğŸ” èªè­‰ç‹€æ…‹ç®¡ç†</h2>
      <div>
        <button class="button" onclick="checkAuthStatus()">æª¢æŸ¥èªè­‰ç‹€æ…‹</button>
        <button class="button" onclick="simulateLogin()">æ¨¡æ“¬ç™»å…¥</button>
        <button class="button" onclick="simulateLogout()">æ¨¡æ“¬ç™»å‡º</button>
      </div>
      <div id="authResult" class="result"></div>
    </div>

    <!-- åŒæ­¥æŒ‰éˆ•æ¸¬è©¦ -->
    <div class="section">
      <h2>ğŸ”„ åŒæ­¥æŒ‰éˆ•æ¸¬è©¦</h2>
      <div>
        <button class="button" onclick="testSyncButton()">
          æª¢æŸ¥åŒæ­¥æŒ‰éˆ•ç‹€æ…‹
        </button>
        <button class="button" onclick="updateAuthUI()">æ›´æ–°èªè­‰ UI</button>
      </div>
      <div id="syncResult" class="result"></div>

      <!-- æ¨¡æ“¬ä¸»é é¢çš„åŒæ­¥æŒ‰éˆ• -->
      <div
        style="
          margin-top: 20px;
          padding: 10px;
          border: 1px solid #555;
          border-radius: 4px;
        "
      >
        <h4>æ¨¡æ“¬ä¸»é é¢ç”¨æˆ¶å€åŸŸï¼š</h4>
        <div id="userInfo" style="display: none">
          <span id="userName">æ¸¬è©¦ç”¨æˆ¶</span>
          <div style="margin-top: 5px">
            <button
              id="syncBtn"
              onclick="triggerSync()"
              style="
                display: none;
                background: #28a745;
                color: white;
                border: none;
                padding: 4px 8px;
                border-radius: 4px;
                font-size: 12px;
                cursor: pointer;
              "
            >
              ğŸ”„ åŒæ­¥æœ¬åœ°è¨˜éŒ„
            </button>
            <button
              onclick="simulateLogout()"
              style="
                background: #dc3545;
                color: white;
                border: none;
                padding: 4px 8px;
                border-radius: 4px;
                font-size: 12px;
                cursor: pointer;
              "
            >
              ç™»å‡º
            </button>
          </div>
        </div>
        <div id="loginPrompt" style="display: block">
          <button
            style="
              background: #007bff;
              color: white;
              border: none;
              padding: 8px 12px;
              border-radius: 4px;
            "
          >
            Google ç™»å…¥
          </button>
        </div>
      </div>
    </div>

    <script>
      // æœ¬åœ°è¨˜éŒ„ç®¡ç†å‡½æ•¸
      function getLocalScores() {
        try {
          const scores = localStorage.getItem("pac_map_local_scores");
          return scores ? JSON.parse(scores) : [];
        } catch (error) {
          console.error("è®€å–æœ¬åœ°åˆ†æ•¸å¤±æ•—:", error);
          return [];
        }
      }

      function createTestLocalScores() {
        const testScores = [
          {
            id: Date.now() + 1,
            score: 2850,
            level: 3,
            map_index: 0,
            survival_time: 245,
            dots_collected: 67,
            ghosts_eaten: 4,
            created_at: new Date().toISOString(),
          },
          {
            id: Date.now() + 2,
            score: 1920,
            level: 2,
            map_index: 1,
            survival_time: 180,
            dots_collected: 45,
            ghosts_eaten: 2,
            created_at: new Date(Date.now() - 3600000).toISOString(),
          },
          {
            id: Date.now() + 3,
            score: 3200,
            level: 4,
            map_index: 0,
            survival_time: 320,
            dots_collected: 89,
            ghosts_eaten: 6,
            created_at: new Date(Date.now() - 7200000).toISOString(),
          },
        ];

        const existingScores = getLocalScores();
        const allScores = [...existingScores, ...testScores];

        localStorage.setItem("pac_map_local_scores", JSON.stringify(allScores));

        document.getElementById(
          "localResult"
        ).textContent = `âœ… å·²å‰µå»º ${testScores.length} å€‹æ¸¬è©¦è¨˜éŒ„\nç¸½è¨˜éŒ„æ•¸: ${allScores.length}`;

        // æ›´æ–°åŒæ­¥æŒ‰éˆ•ç‹€æ…‹
        updateAuthUI();
      }

      function showLocalScores() {
        const scores = getLocalScores();
        const result = document.getElementById("localResult");

        if (scores.length === 0) {
          result.textContent = "âŒ æ²’æœ‰æœ¬åœ°è¨˜éŒ„";
        } else {
          result.textContent =
            `ğŸ“Š æœ¬åœ°è¨˜éŒ„ (${scores.length} ç­†):\n\n` +
            scores
              .map(
                (score, index) =>
                  `${index + 1}. åˆ†æ•¸: ${score.score}, åœ°åœ–: ${
                    score.map_index
                  }, æ™‚é–“: ${score.created_at || "æœªçŸ¥"}`
              )
              .join("\n");
        }
      }

      function clearLocalScores() {
        if (confirm("ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰æœ¬åœ°è¨˜éŒ„å—ï¼Ÿ")) {
          localStorage.removeItem("pac_map_local_scores");
          document.getElementById("localResult").textContent =
            "ğŸ—‘ï¸ æœ¬åœ°è¨˜éŒ„å·²æ¸…é™¤";

          // æ›´æ–°åŒæ­¥æŒ‰éˆ•ç‹€æ…‹
          updateAuthUI();
        }
      }

      // èªè­‰ç‹€æ…‹ç®¡ç†å‡½æ•¸
      function getCurrentUser() {
        try {
          const user = localStorage.getItem("pac_map_user");
          return user ? JSON.parse(user) : null;
        } catch (error) {
          console.error("è®€å–ç”¨æˆ¶è³‡è¨Šå¤±æ•—:", error);
          return null;
        }
      }

      function isLoggedIn() {
        return !!(getCurrentUser() && localStorage.getItem("pac_map_token"));
      }

      function checkAuthStatus() {
        const user = getCurrentUser();
        const loggedIn = isLoggedIn();

        document.getElementById("authResult").textContent =
          `èªè­‰ç‹€æ…‹: ${loggedIn ? "å·²ç™»å…¥" : "æœªç™»å…¥"}\n` +
          `ç”¨æˆ¶è³‡è¨Š: ${user ? JSON.stringify(user, null, 2) : "ç„¡"}`;
      }

      function simulateLogin() {
        const mockUser = {
          id: "test-user-123",
          name: "æ¸¬è©¦ç”¨æˆ¶",
          email: "test@example.com",
          picture: "https://via.placeholder.com/40",
        };

        localStorage.setItem("pac_map_user", JSON.stringify(mockUser));
        localStorage.setItem("pac_map_token", "mock-token-" + Date.now());

        document.getElementById("authResult").textContent = "âœ… å·²æ¨¡æ“¬ç™»å…¥ç‹€æ…‹";

        updateAuthUI();
      }

      function simulateLogout() {
        localStorage.removeItem("pac_map_user");
        localStorage.removeItem("pac_map_token");

        document.getElementById("authResult").textContent = "âœ… å·²æ¨¡æ“¬ç™»å‡ºç‹€æ…‹";

        updateAuthUI();
      }

      // åŒæ­¥æŒ‰éˆ•æ¸¬è©¦å‡½æ•¸
      function updateAuthUI() {
        const loginPrompt = document.getElementById("loginPrompt");
        const userInfo = document.getElementById("userInfo");
        const userName = document.getElementById("userName");
        const syncBtn = document.getElementById("syncBtn");

        const currentUser = getCurrentUser();
        const localScores = getLocalScores();

        if (currentUser) {
          // å·²ç™»å…¥ç‹€æ…‹
          loginPrompt.style.display = "none";
          userInfo.style.display = "block";
          userName.textContent = currentUser.name;

          // æª¢æŸ¥æ˜¯å¦éœ€è¦é¡¯ç¤ºåŒæ­¥æŒ‰éˆ•
          if (localScores.length > 0) {
            syncBtn.style.display = "inline-block";
          } else {
            syncBtn.style.display = "none";
          }
        } else {
          // æœªç™»å…¥ç‹€æ…‹
          loginPrompt.style.display = "block";
          userInfo.style.display = "none";
          syncBtn.style.display = "none";
        }

        // æ›´æ–°æ¸¬è©¦çµæœ
        testSyncButton();
      }

      function testSyncButton() {
        const syncBtn = document.getElementById("syncBtn");
        const localScores = getLocalScores();
        const user = getCurrentUser();

        let result = `åŒæ­¥æŒ‰éˆ•æ¸¬è©¦çµæœ:\n`;
        result += `- æœ¬åœ°è¨˜éŒ„: ${localScores.length} ç­†\n`;
        result += `- ç”¨æˆ¶ç‹€æ…‹: ${user ? "å·²ç™»å…¥" : "æœªç™»å…¥"}\n`;
        result += `- æŒ‰éˆ•é¡¯ç¤º: ${
          syncBtn.style.display !== "none" ? "é¡¯ç¤º" : "éš±è—"
        }\n`;
        result += `- é æœŸé¡¯ç¤º: ${
          user && localScores.length > 0 ? "æ‡‰è©²é¡¯ç¤º" : "æ‡‰è©²éš±è—"
        }\n`;

        const isCorrect =
          (user && localScores.length > 0) ===
          (syncBtn.style.display !== "none");
        result += `- æ¸¬è©¦çµæœ: ${isCorrect ? "âœ… æ­£ç¢º" : "âŒ éŒ¯èª¤"}`;

        document.getElementById("syncResult").textContent = result;
      }

      function triggerSync() {
        const user = getCurrentUser();
        const localScores = getLocalScores();

        if (!user) {
          alert("âŒ éœ€è¦å…ˆç™»å…¥æ‰èƒ½åŒæ­¥");
          return;
        }

        if (localScores.length === 0) {
          alert("âŒ æ²’æœ‰æœ¬åœ°è¨˜éŒ„éœ€è¦åŒæ­¥");
          return;
        }

        // æ¨¡æ“¬åŒæ­¥éç¨‹
        if (confirm(`ğŸ”„ ç¢ºå®šè¦åŒæ­¥ ${localScores.length} ç­†æœ¬åœ°è¨˜éŒ„å—ï¼Ÿ`)) {
          alert(
            "âœ… åŒæ­¥å®Œæˆï¼ï¼ˆé€™æ˜¯æ¨¡æ“¬ï¼‰\n\nåœ¨çœŸå¯¦ç’°å¢ƒä¸­ï¼Œé€™æœƒè§¸ç™¼é·ç§»å°è©±æ¡†ã€‚"
          );

          // æ¨¡æ“¬åŒæ­¥å®Œæˆå¾Œçš„è¡Œç‚º
          if (confirm("æ˜¯å¦è¦æ¸…é™¤æœ¬åœ°è¨˜éŒ„ï¼Ÿ")) {
            localStorage.removeItem("pac_map_local_scores");
            updateAuthUI();
            showLocalScores();
          }
        }
      }

      // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
      window.addEventListener("load", function () {
        console.log("ğŸ§ª ç°¡å–®æ¸¬è©¦é é¢å·²è¼‰å…¥");
        checkAuthStatus();
        showLocalScores();
        updateAuthUI();
      });
    </script>
  </body>
</html>
