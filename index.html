<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenStreetMap å°ç²¾éˆéŠæˆ²</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Press Start 2P', cursive;
            background: #000;
            overflow: hidden;
            color: #fff;
        }

        .game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }

        #map { /* ä¸»è¦éŠæˆ²åœ°åœ– */
            width: 100%;
            height: 100%;
            z-index: 1;
            background-color: #111;
            transition: filter 2.5s ease-in-out; 
        }

        #map.fading-to-black {
            filter: brightness(0%) grayscale(100%); 
        }

        #startScreenMap {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 998;
            background-color: #000;
            filter: brightness(0.35) grayscale(0.1);
            transition: opacity 0.5s ease-in-out;
        }

        .screen-overlay { /* é€šç”¨å…¨è¢å¹•è¦†è“‹å±¤æ¨£å¼ */
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            text-align: center;
            overflow-y: auto;
            box-sizing: border-box;
        }

        .start-screen {
            background: rgba(0,0,0,0.3);
            z-index: 1000; 
        }
        
        .map-selection-screen {
            background: rgba(0, 0, 0, 0.85); 
            z-index: 1001; 
            display: none; 
        }
        .map-selection-screen h2 {
            font-size: clamp(2rem, 6vw, 3.5rem);
            color: #ffff00;
            text-shadow: 2px 2px 0px #ff0000;
            margin-bottom: 2rem;
        }


        .game-title {
            font-size: clamp(2.5rem, 8vw, 4.5rem);
            color: #ffff00;
            text-shadow: 0 0 5px #fff, 0 0 10px #fff, 0 0 15px #ffff00, 0 0 20px #ffff00, 0 0 25px #ffff00, 0 0 30px #ff0000, 0 0 35px #ff0000;
            margin-bottom: 1.5rem; 
            animation: gameTitlePulse 2s infinite ease-in-out;
            letter-spacing: 0.1em;
        }
        
        @keyframes gameTitlePulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.85; }
        }
        
        .start-screen-actions { /* ä¸»ç•«é¢æŒ‰éˆ•å®¹å™¨ */
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap; /* æŒ‰éˆ•éå¤šæ™‚æ›è¡Œ */
            margin-bottom: 1rem;
        }


        .pacman-pixel-button {
            font-family: 'Press Start 2P', cursive;
            background-color: #2121DE; 
            color: #FFFF00; 
            border: 3px solid #000000; 
            padding: 12px 24px; 
            font-size: clamp(0.9rem, 3vw, 1.2rem); 
            text-transform: uppercase;
            border-radius: 0; 
            box-shadow: 4px 4px 0px #000000c0; 
            cursor: pointer;
            transition: transform 0.05s ease-out, box-shadow 0.05s ease-out, background-color 0.05s ease-out;
            margin: 10px; 
            display: inline-block; 
            outline: none;
            min-width: 180px; 
        }
        .pacman-pixel-button:hover {
            background-color: #4242FF; 
            color: #FFFF66; 
            box-shadow: 2px 2px 0px #000000c0;
            transform: translate(2px, 2px);
        }

        .pacman-pixel-button:active {
            background-color: #0000B3; 
            box-shadow: 0px 0px 0px #000000c0;
            transform: translate(4px, 4px);
        }
        
        .map-button { 
            margin: 8px;
        }
        
        .map-button.pacman-pixel-button.active {
            background-color: #FFFF00; 
            color: #2121DE; 
            border-color: #000000; 
            box-shadow: 2px 2px 0px #000000c0; 
            transform: translate(2px, 2px); 
        }
        .map-button.pacman-pixel-button.active:hover {
            background-color: #FFFF66; 
            color: #0000B3; 
        }
        
        .poi-icon-container {
            z-index: 2000 !important;
        }

        /* 1. Flexbox å¸ƒå±€çš„åŒ…è£¹å®¹å™¨ */
        .poi-icon-wrapper {
            display: flex;
            flex-direction: column; /* å‚ç›´æ’åˆ—ï¼šå›¾æ ‡åœ¨ä¸Šï¼Œæ ‡é¢˜åœ¨ä¸‹ */
            align-items: center;    /* æ°´å¹³å±…ä¸­æ‰€æœ‰å­å…ƒç´  */
        }

        /* 2. å›¾æ ‡ (æ°´æ»´) æœ¬èº« */
        .poi-icon {
            width: 24px;
            height: 24px;
            border-radius: 50% 50% 50% 0; /* æ°´æ»´å½¢çŠ¶ */
            transform: rotate(-45deg);     /* æ—‹è½¬æ°´æ»´ */
            border: 2px solid white;
            box-shadow: 0 0 8px rgba(0,0,0,0.5);
            
            /* ä½¿ç”¨ Flexbox è®©å†…éƒ¨çš„å­—æ¯ä¹Ÿå±…ä¸­ */
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* 3. å›¾æ ‡å†…çš„å­—æ¯ */
        .poi-letter {
            display: block;
            transform: rotate(45deg); /* æŠŠå­—æ¯æ—‹è½¬å›æ¥ */
            color: white;
            font-family: 'Press Start 2P', cursive;
            font-size: 14px;
            font-weight: bold;
            text-shadow: 1px 1px 2px black;
        }

        /* 4. ä¸‹æ–¹çš„æ–‡å­—æ ‡ç­¾ */
        .poi-title {
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-family: sans-serif;
            white-space: nowrap;
            margin-top: 4px; /* å›¾æ ‡å’Œæ ‡ç­¾ä¹‹é—´çš„é—´è· */
            pointer-events: none; /* é¿å…é®æŒ¡é¼ æ ‡äº‹ä»¶ */
        }

        /* 5. ä¸“å±é¢œè‰² (ä¿æŒä¸å˜) */
        .monument-icon {
            background-color: #a0522d;
        }
        .store-icon {
            background-color: #2e8b57;
        }
        .park-icon {
            background-color: #006400;
        }

        .content-toggle-container { /* åŒ…è£¹èªªæ˜å’Œæ’è¡Œæ¦œå…§å®¹çš„å®¹å™¨ */
            width: 100%;
            max-width: 600px; /* èˆ‡å…§å®¹å€å¡Šå¯¬åº¦ä¸€è‡´ */
            margin-top: 1rem;
        }
        .health-bar-container {
            width: 100%; /* è®“å®¹å™¨å¯¬åº¦èˆ‡ .game-ui çš„å…§å®¹å€å°é½Š */
            height: 14px; /* è¡€æ¢çš„é«˜åº¦ */
            background-color: #333; /* è¡€æ¢çš„èƒŒæ™¯è‰² (ç©ºè¡€æ™‚çš„é¡è‰²) */
            border: 2px solid #555; /* è¡€æ¢çš„é‚Šæ¡† */
            border-radius: 7px; /* åœ“è§’æ•ˆæœ */
            padding: 2px; /* å…§é‚Šè·ï¼Œè®“å¡«å……æ¢å’Œé‚Šæ¡†ä¹‹é–“æœ‰é»ç©ºéš™ */
            box-sizing: border-box; /* ç¢ºä¿ padding å’Œ border ä¸æœƒå¢åŠ ç¸½å¯¬åº¦ */
            margin: 8px 0; /* èˆ‡ä¸Šä¸‹å…ƒç´ çš„é–“è· */
        }

        .health-bar {
            height: 100%; /* å¡«å……æ¢é«˜åº¦èˆ‡å®¹å™¨ä¸€è‡´ */
            width: 100%;  /* åˆå§‹å¯¬åº¦ç‚º 100% (æ»¿è¡€) */
            background-color: #00ff00; /* æ»¿è¡€æ™‚çš„é¡è‰² (ç¶ è‰²) */
            border-radius: 4px; /* å¡«å……æ¢è‡ªå·±çš„åœ“è§’ */
            
            /* é€™æ˜¯æœ€é‡è¦çš„éƒ¨åˆ†ï¼šå¹³æ»‘çš„éæ¸¡å‹•ç•« */
            transition: width 0.5s ease-in-out, background-color 0.5s ease-in-out;
        }
        .instructions, .leaderboard {
            max-width: 600px;
            width: 100%; /* ç›¸å°æ–¼ .content-toggle-container */
            margin: 0 auto 1rem auto; /* æ°´å¹³å±…ä¸­ï¼Œåº•éƒ¨ç•™ç™½ */
            padding: 20px;
            background: rgba(0, 0, 0, 0.75); /* ç¨å¾®åŠ æ·±ä¸€é» */
            border: 3px solid #ffff00; /* åŠ ç²—é‚Šæ¡† */
            border-radius: 0px; 
            box-shadow: 0 0 10px rgba(255, 255, 0, 0.2);
            display: none; 
        }
        .instructions h3, .leaderboard h3 {
            color: #ffff00;
            margin-bottom: 1rem;
            font-size: clamp(1.2rem, 5vw, 1.8rem);
            text-shadow: 2px 2px 0px #000; /* åŠ ç²—é™°å½± */
        }
        .instructions ul, .leaderboard ol {
            list-style: none;
            line-height: 1.8;
            padding-left: 0;
            font-size: clamp(0.8rem, 3vw, 1rem);
        }
        .instructions li { margin: 10px 0; padding-left: 25px; position: relative; }
        .instructions li:before { content: ">>"; position: absolute; left: 0; color: #ffff00; font-weight: bold; }
        
        .leaderboard ol { padding-left: 0; } /* ç¢ºä¿æ’è¡Œæ¦œåˆ—è¡¨ä¸å…§ç¸® */
        .leaderboard li { counter-increment: leaderboard; padding: 8px 10px; margin: 6px 0; background: rgba(30, 30, 80, 0.5); border-radius: 0px; border-left: 4px solid #ffff00; }
        .leaderboard li:before { content: counter(leaderboard) ". "; font-weight: bold; color: #ffff00; margin-right: 10px; }

        .game-ui { position: absolute; top: 20px; left: 20px; z-index: 500; background: rgba(0, 0, 0, 0.8); color: white; padding: 15px; border-radius: 10px; font-family: 'Press Start 2P', cursive; font-size: 14px; border: 1px solid #555; }
        .ui-row { display: flex; justify-content: space-between; margin: 5px 0; min-width: 300px; }

        .pause-screen {
            background: rgba(10, 10, 30, 0.92); /* æ·±è—è‰²èª¿èƒŒæ™¯ */
            border: 4px solid #FFB84D; /* é¬¼æ€ªæ©™è‰²é‚Šæ¡† */
            box-shadow: 0 0 25px #FFB84D, inset 0 0 20px rgba(0,0,0,0.5); 
            z-index: 2500; 
            color: white;
            display: none;
        }
        .pause-screen h2 {
            font-size: clamp(2.8rem, 8vw, 4.5rem); 
            color: #FF0000; 
            text-shadow: 3px 3px 0px #000000, 
                         0 0 8px #fff, 
                         0 0 12px #FF0000,
                         0 0 18px #FFB84D; /* åŠ å…¥æ©™è‰²å…‰æšˆ */
            margin-bottom: 2.5rem;
            animation: blinkRed 0.8s infinite steps(1, end); /* èª¿æ•´é–ƒçˆé€Ÿåº¦ */
        }
        #minimap-container {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 200px;  /* å°åœ°å›¾å®½åº¦ */
            height: 200px; /* å°åœ°å›¾é«˜åº¦ */
            z-index: 1000; /* ç¡®ä¿å®ƒåœ¨æ¸¸æˆ UI ä¹‹ä¸Š */
            border: 3px solid #ffff00;
            box-shadow: 0 0 15px rgba(255, 255, 0, 0.5);
            background-color: #111;
            border-radius: 5px; /* è½»å¾®çš„åœ†è§’ */
            overflow: hidden; /* éšè—åœ°å›¾è¶…å‡ºéƒ¨åˆ† */
            display: none;
        }
        #minimap {
            width: 100%;
            height: 100%;
        }
        .minimap-player-icon {
            background-color: #ffff00; /* é»„è‰² */
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 8px #ffff00;
        }

        @keyframes blinkRed { /* èª¿æ•´é–ƒçˆæ•ˆæœ */
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.02); }
        }
        .pause-screen .pacman-pixel-button { margin: 15px; }


        .game-over-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 2500; color: white; }
        .map-selector { margin: 20px 0; } /* ç”¨æ–¼åœ°åœ–é¸æ“‡ç•Œé¢ä¸­çš„æŒ‰éˆ•çµ„ */
        .countdown { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 5rem; color: #ffff00; text-shadow: 3px 3px 0px #ff6b6b; z-index: 600; display: none; }
        .pacman-icon { width: 24px; height: 24px; background-color: #ffff00; border-radius: 50%; position: relative; transition: transform 0.05s linear, opacity 0.3s ease-out; }
        .pacman-icon.hidden { opacity: 0; pointer-events: none; }
        .pacman-icon::before { content: ''; position: absolute; width: 0; height: 0; top: 50%; left: 12px; transform: translateY(-50%); border-style: solid; border-color: transparent #111 transparent transparent; animation: pacman-mouth-chomp 0.4s infinite; }
        @keyframes pacman-mouth-chomp { 0%, 100% { border-width: 12px 12px 12px 0; } 50% { border-width: 4px 12px 4px 0; } }
        .pacman-icon.facing-true-left { transform: rotate(180deg); } 
        .pacman-icon.facing-true-right { transform: rotate(0deg); }   
        .pacman-icon.facing-true-up { transform: rotate(-90deg); }  
        .pacman-icon.facing-true-down { transform: rotate(90deg); } 
        .ghost-icon { width: 20px; height: 20px; border-radius: 10px 10px 0 0; position: relative; overflow: visible; }
        .ghost-icon::before, .ghost-icon::after { content: ''; position: absolute; width: 6px; height: 8px; background-color: white; border-radius: 50%; top: 4px; border: 1px solid #555; }
        .ghost-icon::before { left: 3px; } 
        .ghost-icon::after { right: 3px; } 
        .ghost-icon > div.wave1, .ghost-icon > div.wave2, .ghost-icon > div.wave3 { position: absolute; bottom: -6px; width: 33.33%; height: 6px; background-color: inherit; border-radius: 0 0 50% 50% / 0 0 100% 100%; }
        .ghost-icon > div.wave1 { left: 0; }
        .ghost-icon > div.wave2 { left: 33.33%; }
        .ghost-icon > div.wave3 { left: 66.66%; }
        .ghost-red { background: #ff0000; } .ghost-pink { background: #ffc0cb; } .ghost-cyan { background: #00ffff; } .ghost-orange { background: #ffb84d; } .ghost-purple { background: #800080; } .ghost-green { background: #008000; } .ghost-blue { background: #0000ff; }   
        .ghost-scared { background: #2222dd; }
        .ghost-scared::before, .ghost-scared::after { background-color: white; width: 8px; height: 4px; top: 7px; }
        @keyframes ghost-eaten-fade { 0% { opacity: 1; transform: scale(1); } 100% { opacity: 0; transform: scale(0.5) translateY(-15px); } }
        .ghost-icon.ghost-eaten { animation: ghost-eaten-fade 0.5s forwards; }
        .wasted-screen-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0); display: none; justify-content: center; align-items: center; z-index: 2000; transition: background-color 2.5s ease-in-out; }
        .wasted-screen-overlay.active { display: flex; background-color: rgba(0, 0, 0, 1); }
        .wasted-banner { width: 100%; background-color: #000000; padding: 20px 0; text-align: center; opacity: 0; transform: scale(1) translateY(0); }
        .wasted-text { font-family: 'Impact', Haettenschweiler, 'Arial Narrow Bold', sans-serif; font-size: 6rem; color: #D32F2F; font-weight: bold; text-transform: uppercase; letter-spacing: 0.05em; text-shadow: 2px 2px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000, 3px 3px 5px rgba(0,0,0,0.5); }
        .dot { width: 4px; height: 4px; background: #ffff00; border-radius: 50%; }
        .power-pellet { width: 12px; height: 12px; background: #ffff00; border-radius: 50%; animation: blink 1s infinite; }
        @keyframes blink { 0%, 50% { opacity: 1; } 51%, 100% { opacity: 0.3; } }
        .dev-console { position: absolute; bottom: 0; left: 0; width: 100%; background-color: rgba(0, 0, 0, 0.85); color: #0f0; font-family: 'Courier New', Courier, monospace; font-size: 14px; padding: 10px; z-index: 3000; display: none; border-top: 2px solid #0f0; }
        .dev-console-output { height: 100px; overflow-y: auto; margin-bottom: 10px; border: 1px solid #0a0; padding: 5px; white-space: pre-wrap; }
        .dev-console-input { width: calc(100% - 20px); background-color: #111; color: #0f0; border: 1px solid #0a0; padding: 5px; font-family: 'Courier New', Courier, monospace; font-size: 14px; }
        .dev-console-input:focus { outline: none; border-color: #0f0; }
    </style>
</head>
<body>
    <div class="game-container">
        <div id="startScreenMap"></div>
        <div id="map"></div>

        <div class="wasted-screen-overlay" id="wastedScreenOverlay">
            <div class="wasted-banner" id="wastedBanner"> <span class="wasted-text">WASTED</span></div>
        </div>

        <div class="countdown" id="countdown"></div>

        <div class="game-ui" id="gameUI" style="display: none;">
            <div class="ui-row">
                <span>åˆ†æ•¸: <span id="score">0</span></span>
                <span>ç”Ÿå‘½: <span id="lives">3</span></span>
            </div>
            <div class="health-bar-container">
                <div id="healthBar" class="health-bar"></div>
            </div>
            <div class="ui-row">
                <span>é—œå¡: <span id="level">1</span></span>
                <span>æ™‚é–“: <span id="timer">5:00</span></span>
            </div>
            <div class="ui-row">
                <span>å‰©é¤˜é»æ•¸: <span id="dotsLeft">0</span></span>
                <span>æœ€é«˜åˆ†: <span id="highScore">0</span></span>
            </div>
        </div>

        <div class="screen-overlay start-screen" id="startScreen">
            <h1 class="game-title">PAC-MAP</h1>
            <div class="start-screen-actions">
                <button class="pacman-pixel-button" id="startGameBtn">é–‹å§‹éŠæˆ²</button>
                <button class="pacman-pixel-button" id="instructionsBtn">éŠæˆ²èªªæ˜</button>
                <button class="pacman-pixel-button" id="leaderboardBtn">æ’è¡Œæ¦œ</button>
            </div>
            <div class="content-toggle-container">
                <div class="instructions" id="instructionsContent">
                    <h3> éŠæˆ²èªªæ˜</h3>
                    <ul>
                        <li>ä½¿ç”¨ WASD æˆ–æ–¹å‘éµæ§åˆ¶å°ç²¾éˆç§»å‹•</li>
                        <li>ç©ºç™½éµæš«åœéŠæˆ²</li>
                        <li>æ”¶é›†é»ƒè‰²é»æ•¸ (20åˆ†) å’Œå¤§åŠ›ä¸¸ (50åˆ†)</li>
                        <li>åƒå¤§åŠ›ä¸¸å¾Œå¯ä»¥æ“Šæ®ºé¬¼æ€ª (150åˆ†)</li>
                        <li>é¿å…è¢«é¬¼æ€ªæŠ“åˆ°ï¼Œä½ æœ‰ 3 æ¢å‘½</li>
                        <li>10åˆ†é˜å…§æ”¶é›†å®Œæ‰€æœ‰é»æ•¸æ™‰ç´šä¸‹ä¸€é—œ</li>
                    </ul>
                </div>
                <div class="leaderboard" id="leaderboardContent">
                    <h3> æ’è¡Œæ¦œ</h3>
                    <ol id="leaderboardList">
                        <li>æš«ç„¡è¨˜éŒ„</li>
                    </ol>
                </div>
            </div>
        </div>

        <div class="screen-overlay map-selection-screen" id="mapSelectionScreen">
            <h2>é¸æ“‡åœ°åœ–</h2>
            <div class="map-selector">
                <button class="map-button pacman-pixel-button active" data-map-index="0">å°åŒ—å¸‚ä¸­å¿ƒ</button>
                <button class="map-button pacman-pixel-button" data-map-index="1">å°ä¸­å¸‚å€</button>
                <button class="map-button pacman-pixel-button" data-map-index="2">é«˜é›„å¸‚å€</button>
            </div>
            <button class="pacman-pixel-button" id="backToStartScreenBtn">è¿”å›ä¸»é¸å–®</button>
        </div>

        <div class="screen-overlay pause-screen" id="pauseScreen">
            <h2>éŠæˆ²æš«åœ</h2>
            <button class="pacman-pixel-button" id="resumeGameBtn">ç¹¼çºŒéŠæˆ²</button>
            <button class="pacman-pixel-button" id="backToMenuBtnPause">å›åˆ°ä¸»é¸å–®</button> 
        </div>

        <div class="screen-overlay game-over-screen" id="gameOverScreen">
            <h2 id="gameOverTitle">éŠæˆ²çµæŸ</h2>
            <div class="ui-row" style="justify-content: center; margin: 20px 0;">
                <span style="font-size: 2rem;">æœ€çµ‚åˆ†æ•¸: <span id="finalScore">0</span></span>
            </div>
            <div id="newHighScore" style="display: none; color: #ffff00; font-size: 1.5rem; margin: 10px 0;">
                ğŸ† æ–°ç´€éŒ„ï¼
            </div>
            <button class="pacman-pixel-button" id="restartGameBtn">é‡æ–°é–‹å§‹</button>
            <button class="pacman-pixel-button" id="backToMenuBtnGameOver">å›åˆ°ä¸»é¸å–®</button> 
        </div>

        <div id="minimap-container">
            <div id="minimap"></div>
        </div>

        <div class="dev-console" id="devConsole">
            <div class="dev-console-output" id="devConsoleOutput">é–‹ç™¼è€…æŒ‡ä»¤è¦–çª—å·²å•Ÿç”¨ã€‚è¼¸å…¥ 'help' æŸ¥çœ‹å¯ç”¨æŒ‡ä»¤ã€‚</div>
            <input type="text" class="dev-console-input" id="devConsoleInput" placeholder="è¼¸å…¥æŒ‡ä»¤...">
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <script type="module" src="js/main.js"></script>
    <audio id="bgm" loop>
        <source src="audio/Pacmap_bgm.wav" type="audio/mpeg">
    </audio>
</body>
</html>