<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>åŒæ­¥åŠŸèƒ½å’Œæœ¬åœ°è¨˜éŒ„æ¸¬è©¦</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background: #1a1a1a;
        color: white;
      }
      .test-section {
        background: #2a2a2a;
        border: 2px solid #444;
        border-radius: 8px;
        padding: 20px;
        margin: 20px 0;
      }
      .test-section h2 {
        color: #ffff00;
        margin-top: 0;
      }
      .button {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 5px;
        cursor: pointer;
        margin: 5px;
        font-size: 14px;
      }
      .button:hover {
        background: #0056b3;
      }
      .button.success {
        background: #28a745;
      }
      .button.danger {
        background: #dc3545;
      }
      .button.warning {
        background: #ffc107;
        color: black;
      }
      .result {
        background: #333;
        border: 1px solid #555;
        border-radius: 4px;
        padding: 15px;
        margin: 10px 0;
        font-family: monospace;
        white-space: pre-wrap;
        max-height: 300px;
        overflow-y: auto;
      }
      .status {
        padding: 10px;
        border-radius: 4px;
        margin: 10px 0;
      }
      .status.success {
        background: rgba(40, 167, 69, 0.2);
        border: 1px solid #28a745;
      }
      .status.error {
        background: rgba(220, 53, 69, 0.2);
        border: 1px solid #dc3545;
      }
      .status.info {
        background: rgba(23, 162, 184, 0.2);
        border: 1px solid #17a2b8;
      }
      .grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }
      @media (max-width: 768px) {
        .grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <h1>ğŸ§ª åŒæ­¥åŠŸèƒ½å’Œæœ¬åœ°è¨˜éŒ„æ¸¬è©¦</h1>

    <div class="grid">
      <!-- æœ¬åœ°è¨˜éŒ„ç®¡ç† -->
      <div class="test-section">
        <h2>ğŸ“± æœ¬åœ°è¨˜éŒ„ç®¡ç†</h2>
        <div>
          <button class="button success" onclick="createTestLocalScores()">
            å‰µå»ºæ¸¬è©¦è¨˜éŒ„
          </button>
          <button class="button" onclick="showLocalScores()">
            æŸ¥çœ‹æœ¬åœ°è¨˜éŒ„
          </button>
          <button class="button danger" onclick="clearLocalScores()">
            æ¸…é™¤æœ¬åœ°è¨˜éŒ„
          </button>
        </div>
        <div id="localScoresResult" class="result"></div>
      </div>

      <!-- èªè­‰ç‹€æ…‹ç®¡ç† -->
      <div class="test-section">
        <h2>ğŸ” èªè­‰ç‹€æ…‹ç®¡ç†</h2>
        <div>
          <button class="button" onclick="checkAuthStatus()">
            æª¢æŸ¥èªè­‰ç‹€æ…‹
          </button>
          <button class="button warning" onclick="simulateLogin()">
            æ¨¡æ“¬ç™»å…¥
          </button>
          <button class="button" onclick="simulateLogout()">æ¨¡æ“¬ç™»å‡º</button>
        </div>
        <div id="authResult" class="result"></div>
      </div>
    </div>

    <!-- åŒæ­¥åŠŸèƒ½æ¸¬è©¦ -->
    <div class="test-section">
      <h2>ğŸ”„ åŒæ­¥åŠŸèƒ½æ¸¬è©¦</h2>
      <div>
        <button class="button" onclick="testSyncButtonVisibility()">
          æ¸¬è©¦åŒæ­¥æŒ‰éˆ•é¡¯ç¤º
        </button>
        <button class="button" onclick="triggerManualSync()">
          è§¸ç™¼æ‰‹å‹•åŒæ­¥
        </button>
        <button class="button" onclick="testMigrationDialog()">
          æ¸¬è©¦é·ç§»å°è©±æ¡†
        </button>
      </div>
      <div id="syncResult" class="result"></div>
    </div>

    <!-- æ’è¡Œæ¦œé¡¯ç¤ºæ¸¬è©¦ -->
    <div class="test-section">
      <h2>ğŸ† æ’è¡Œæ¦œé¡¯ç¤ºæ¸¬è©¦</h2>
      <div>
        <button class="button" onclick="testLeaderboardUpdate()">
          æ›´æ–°æ’è¡Œæ¦œ
        </button>
        <button class="button" onclick="testLocalRecordsDisplay()">
          æ¸¬è©¦æœ¬åœ°è¨˜éŒ„é¡¯ç¤º
        </button>
        <button class="button" onclick="simulateOfflineMode()">
          æ¨¡æ“¬é›¢ç·šæ¨¡å¼
        </button>
      </div>
      <div id="leaderboardResult" class="result"></div>
    </div>

    <!-- æ§åˆ¶å°æ—¥èªŒ -->
    <div class="test-section">
      <h2>ğŸ“‹ æ§åˆ¶å°æ—¥èªŒ</h2>
      <div>
        <button class="button" onclick="clearConsoleLog()">æ¸…é™¤æ—¥èªŒ</button>
        <button class="button" onclick="exportConsoleLog()">åŒ¯å‡ºæ—¥èªŒ</button>
      </div>
      <div id="consoleLog" class="result"></div>
    </div>

    <!-- è¼‰å…¥å¿…è¦çš„è…³æœ¬ -->
    <script src="js/config.js"></script>
    <script type="module">
      // ç­‰å¾…é é¢è¼‰å…¥å®Œæˆ
      document.addEventListener("DOMContentLoaded", async function () {
        try {
          // è¼‰å…¥å¿…è¦çš„æ¨¡çµ„
          const gameModule = await import("./js/game.js");
          const authModule = await import("./js/auth.js");
          const uiModule = await import("./js/ui.js");

          // æš´éœ²å‡½æ•¸åˆ°å…¨åŸŸç¯„åœ
          window.getLocalScores = gameModule.getLocalScores;
          window.saveLocalScore = gameModule.saveLocalScore;
          window.clearLocalScores = gameModule.clearLocalScores;
          window.getCurrentUser = authModule.getCurrentUser;
          window.isLoggedIn = authModule.isLoggedIn;
          window.updateAuthUI = authModule.updateAuthUI;
          window.checkAndOfferLocalScoreMigration =
            authModule.checkAndOfferLocalScoreMigration;
          window.updateLeaderboardUI = uiModule.updateLeaderboardUI;

          console.log("âœ… æ‰€æœ‰æ¨¡çµ„å·²è¼‰å…¥");

          // åˆå§‹åŒ–æ¸¬è©¦é é¢
          initTestPage();
        } catch (error) {
          console.error("âŒ æ¨¡çµ„è¼‰å…¥å¤±æ•—:", error);
          document.getElementById(
            "authResult"
          ).textContent = `âŒ æ¨¡çµ„è¼‰å…¥å¤±æ•—: ${error.message}`;
        }
      });

      // æ””æˆª console.log ä¾†é¡¯ç¤ºæ—¥èªŒ
      const originalConsoleLog = console.log;
      const originalConsoleError = console.error;
      const originalConsoleWarn = console.warn;

      let consoleMessages = [];

      function addConsoleMessage(type, args) {
        const timestamp = new Date().toLocaleTimeString();
        const message = args
          .map((arg) =>
            typeof arg === "object" ? JSON.stringify(arg, null, 2) : String(arg)
          )
          .join(" ");

        consoleMessages.push(
          `[${timestamp}] ${type.toUpperCase()}: ${message}`
        );

        // é™åˆ¶æ—¥èªŒæ•¸é‡
        if (consoleMessages.length > 100) {
          consoleMessages = consoleMessages.slice(-100);
        }

        updateConsoleDisplay();
      }

      console.log = function (...args) {
        originalConsoleLog.apply(console, args);
        addConsoleMessage("log", args);
      };

      console.error = function (...args) {
        originalConsoleError.apply(console, args);
        addConsoleMessage("error", args);
      };

      console.warn = function (...args) {
        originalConsoleWarn.apply(console, args);
        addConsoleMessage("warn", args);
      };

      function updateConsoleDisplay() {
        const consoleDiv = document.getElementById("consoleLog");
        if (consoleDiv) {
          consoleDiv.textContent = consoleMessages.slice(-20).join("\n");
          consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }
      }

      window.clearConsoleLog = function () {
        consoleMessages = [];
        updateConsoleDisplay();
      };

      window.exportConsoleLog = function () {
        const blob = new Blob([consoleMessages.join("\n")], {
          type: "text/plain",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `console-log-${new Date().toISOString().slice(0, 19)}.txt`;
        a.click();
        URL.revokeObjectURL(url);
      };

      // åˆå§‹åŒ–æ¸¬è©¦é é¢
      function initTestPage() {
        console.log("ğŸ§ª æ¸¬è©¦é é¢åˆå§‹åŒ–");

        // æª¢æŸ¥å‡½æ•¸æ˜¯å¦æ­£ç¢ºè¼‰å…¥
        const functions = [
          "getLocalScores",
          "saveLocalScore",
          "clearLocalScores",
          "getCurrentUser",
          "isLoggedIn",
          "updateAuthUI",
          "checkAndOfferLocalScoreMigration",
          "updateLeaderboardUI",
        ];

        const missingFunctions = functions.filter(
          (fn) => typeof window[fn] !== "function"
        );

        if (missingFunctions.length > 0) {
          console.error("âŒ ç¼ºå°‘å‡½æ•¸:", missingFunctions);
          document.getElementById(
            "authResult"
          ).textContent = `âŒ ç¼ºå°‘å‡½æ•¸: ${missingFunctions.join(", ")}`;
        } else {
          console.log("âœ… æ‰€æœ‰å‡½æ•¸å·²æ­£ç¢ºè¼‰å…¥");

          // åˆå§‹åŒ–é¡¯ç¤º
          setTimeout(() => {
            checkAuthStatus();
            showLocalScores();
          }, 100);
        }
      }

      window.initTestPage = initTestPage;
    </script>

    <script>
      // æ¸¬è©¦å‡½æ•¸
      function createTestLocalScores() {
        const testScores = [
          {
            id: Date.now() + 1,
            score: 2850,
            level: 3,
            map_index: 0,
            survival_time: 245,
            dots_collected: 67,
            ghosts_eaten: 4,
            created_at: new Date().toISOString(),
          },
          {
            id: Date.now() + 2,
            score: 1920,
            level: 2,
            map_index: 1,
            survival_time: 180,
            dots_collected: 45,
            ghosts_eaten: 2,
            created_at: new Date(Date.now() - 3600000).toISOString(),
          },
          {
            id: Date.now() + 3,
            score: 3200,
            level: 4,
            map_index: 0,
            survival_time: 320,
            dots_collected: 89,
            ghosts_eaten: 6,
            created_at: new Date(Date.now() - 7200000).toISOString(),
          },
        ];

        // ç²å–ç¾æœ‰è¨˜éŒ„ä¸¦æ·»åŠ æ–°è¨˜éŒ„
        const existingScores = getLocalScores();
        const allScores = [...existingScores, ...testScores];

        localStorage.setItem("pac_map_local_scores", JSON.stringify(allScores));

        document.getElementById(
          "localScoresResult"
        ).textContent = `âœ… å·²å‰µå»º ${testScores.length} å€‹æ¸¬è©¦è¨˜éŒ„\nç¸½è¨˜éŒ„æ•¸: ${allScores.length}`;
      }

      function showLocalScores() {
        const scores = getLocalScores();
        const result = document.getElementById("localScoresResult");

        if (scores.length === 0) {
          result.textContent = "âŒ æ²’æœ‰æœ¬åœ°è¨˜éŒ„";
        } else {
          result.textContent =
            `ğŸ“Š æœ¬åœ°è¨˜éŒ„ (${scores.length} ç­†):\n\n` +
            scores
              .map(
                (score, index) =>
                  `${index + 1}. åˆ†æ•¸: ${score.score}, åœ°åœ–: ${
                    score.map_index
                  }, æ™‚é–“: ${score.created_at || "æœªçŸ¥"}`
              )
              .join("\n");
        }
      }

      function clearLocalScores() {
        if (confirm("ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰æœ¬åœ°è¨˜éŒ„å—ï¼Ÿ")) {
          localStorage.removeItem("pac_map_local_scores");
          document.getElementById("localScoresResult").textContent =
            "ğŸ—‘ï¸ æœ¬åœ°è¨˜éŒ„å·²æ¸…é™¤";
        }
      }

      function checkAuthStatus() {
        const user = getCurrentUser();
        const loggedIn = isLoggedIn();

        document.getElementById("authResult").textContent =
          `èªè­‰ç‹€æ…‹: ${loggedIn ? "å·²ç™»å…¥" : "æœªç™»å…¥"}\n` +
          `ç”¨æˆ¶è³‡è¨Š: ${user ? JSON.stringify(user, null, 2) : "ç„¡"}`;
      }

      function simulateLogin() {
        // æ¨¡æ“¬ç™»å…¥ç‹€æ…‹
        const mockUser = {
          id: "test-user-123",
          name: "æ¸¬è©¦ç”¨æˆ¶",
          email: "test@example.com",
          picture: "https://via.placeholder.com/40",
        };

        localStorage.setItem("pac_map_user", JSON.stringify(mockUser));
        localStorage.setItem("pac_map_token", "mock-token-" + Date.now());

        document.getElementById("authResult").textContent = "âœ… å·²æ¨¡æ“¬ç™»å…¥ç‹€æ…‹";

        // æ›´æ–°èªè­‰ UI
        updateAuthUI();
      }

      function simulateLogout() {
        localStorage.removeItem("pac_map_user");
        localStorage.removeItem("pac_map_token");

        document.getElementById("authResult").textContent = "âœ… å·²æ¨¡æ“¬ç™»å‡ºç‹€æ…‹";

        // æ›´æ–°èªè­‰ UI
        updateAuthUI();
      }

      function testSyncButtonVisibility() {
        const syncBtn = document.getElementById("syncBtn");
        const localScores = getLocalScores();
        const user = getCurrentUser();

        let result = `åŒæ­¥æŒ‰éˆ•æ¸¬è©¦:\n`;
        result += `- æœ¬åœ°è¨˜éŒ„: ${localScores.length} ç­†\n`;
        result += `- ç”¨æˆ¶ç‹€æ…‹: ${user ? "å·²ç™»å…¥" : "æœªç™»å…¥"}\n`;
        result += `- æŒ‰éˆ•å­˜åœ¨: ${syncBtn ? "æ˜¯" : "å¦"}\n`;

        if (syncBtn) {
          result += `- æŒ‰éˆ•é¡¯ç¤º: ${
            syncBtn.style.display !== "none" ? "é¡¯ç¤º" : "éš±è—"
          }\n`;
          result += `- é æœŸé¡¯ç¤º: ${
            user && localScores.length > 0 ? "æ‡‰è©²é¡¯ç¤º" : "æ‡‰è©²éš±è—"
          }`;
        }

        document.getElementById("syncResult").textContent = result;
      }

      function triggerManualSync() {
        const user = getCurrentUser();
        const localScores = getLocalScores();

        if (!user) {
          document.getElementById("syncResult").textContent =
            "âŒ éœ€è¦å…ˆç™»å…¥æ‰èƒ½åŒæ­¥";
          return;
        }

        if (localScores.length === 0) {
          document.getElementById("syncResult").textContent =
            "âŒ æ²’æœ‰æœ¬åœ°è¨˜éŒ„éœ€è¦åŒæ­¥";
          return;
        }

        document.getElementById("syncResult").textContent =
          "ğŸ”„ è§¸ç™¼æ‰‹å‹•åŒæ­¥...";

        try {
          checkAndOfferLocalScoreMigration();
          document.getElementById("syncResult").textContent =
            "âœ… åŒæ­¥å°è©±æ¡†å·²è§¸ç™¼";
        } catch (error) {
          document.getElementById(
            "syncResult"
          ).textContent = `âŒ åŒæ­¥è§¸ç™¼å¤±æ•—: ${error.message}`;
        }
      }

      function testMigrationDialog() {
        // ç¢ºä¿æœ‰æ¸¬è©¦æ¢ä»¶
        const user = getCurrentUser();
        const localScores = getLocalScores();

        let result = `é·ç§»å°è©±æ¡†æ¸¬è©¦:\n`;
        result += `- ç”¨æˆ¶ç‹€æ…‹: ${user ? "å·²ç™»å…¥" : "æœªç™»å…¥"}\n`;
        result += `- æœ¬åœ°è¨˜éŒ„: ${localScores.length} ç­†\n`;

        if (!user) {
          result += `âŒ éœ€è¦å…ˆæ¨¡æ“¬ç™»å…¥`;
        } else if (localScores.length === 0) {
          result += `âŒ éœ€è¦å…ˆå‰µå»ºæ¸¬è©¦è¨˜éŒ„`;
        } else {
          result += `âœ… æ¢ä»¶æ»¿è¶³ï¼Œå¯ä»¥æ¸¬è©¦é·ç§»`;
          try {
            checkAndOfferLocalScoreMigration();
            result += `\nğŸ”„ é·ç§»å°è©±æ¡†å·²è§¸ç™¼`;
          } catch (error) {
            result += `\nâŒ è§¸ç™¼å¤±æ•—: ${error.message}`;
          }
        }

        document.getElementById("syncResult").textContent = result;
      }

      function testLeaderboardUpdate() {
        document.getElementById("leaderboardResult").textContent =
          "ğŸ”„ æ›´æ–°æ’è¡Œæ¦œ...";

        try {
          updateLeaderboardUI();
          document.getElementById("leaderboardResult").textContent =
            "âœ… æ’è¡Œæ¦œæ›´æ–°å·²è§¸ç™¼ï¼Œè«‹æŸ¥çœ‹æ§åˆ¶å°æ—¥èªŒ";
        } catch (error) {
          document.getElementById(
            "leaderboardResult"
          ).textContent = `âŒ æ’è¡Œæ¦œæ›´æ–°å¤±æ•—: ${error.message}`;
        }
      }

      function testLocalRecordsDisplay() {
        const user = getCurrentUser();
        const localScores = getLocalScores();

        let result = `æœ¬åœ°è¨˜éŒ„é¡¯ç¤ºæ¸¬è©¦:\n`;
        result += `- ç”¨æˆ¶ç‹€æ…‹: ${user ? "å·²ç™»å…¥" : "æœªç™»å…¥"}\n`;
        result += `- æœ¬åœ°è¨˜éŒ„: ${localScores.length} ç­†\n`;
        result += `- é æœŸè¡Œç‚º: ${
          !user && localScores.length > 0
            ? "æ‡‰è©²é¡¯ç¤ºæœ¬åœ°è¨˜éŒ„"
            : "ä¸æ‡‰è©²é¡¯ç¤ºæœ¬åœ°è¨˜éŒ„"
        }\n`;

        // è§¸ç™¼æ’è¡Œæ¦œæ›´æ–°ä¾†æ¸¬è©¦é¡¯ç¤º
        try {
          updateLeaderboardUI();
          result += `âœ… æ’è¡Œæ¦œæ›´æ–°å·²è§¸ç™¼ï¼Œè«‹æŸ¥çœ‹ä¸»é é¢æ’è¡Œæ¦œå€åŸŸ`;
        } catch (error) {
          result += `âŒ æ¸¬è©¦å¤±æ•—: ${error.message}`;
        }

        document.getElementById("leaderboardResult").textContent = result;
      }

      function simulateOfflineMode() {
        // é€™å€‹å‡½æ•¸å¯ä»¥ç”¨ä¾†æ¸¬è©¦é›¢ç·šæ¨¡å¼ä¸‹çš„æ’è¡Œæ¦œé¡¯ç¤º
        document.getElementById("leaderboardResult").textContent =
          "ğŸ’¡ é›¢ç·šæ¨¡å¼æ¸¬è©¦:\n" +
          "1. é—œé–‰å¾Œç«¯ä¼ºæœå™¨\n" +
          "2. é»æ“Šã€Œæ›´æ–°æ’è¡Œæ¦œã€\n" +
          "3. æ‡‰è©²é¡¯ç¤ºæœ¬åœ°è¨˜éŒ„ä½œç‚ºå‚™ç”¨";
      }

      // é é¢è¼‰å…¥æ™‚çš„åˆå§‹åŒ–
      window.addEventListener("load", function () {
        console.log("ğŸ§ª æ¸¬è©¦é é¢å·²è¼‰å…¥");
        // ç­‰å¾…æ¨¡çµ„è¼‰å…¥å®Œæˆå¾Œå†åˆå§‹åŒ–
        setTimeout(() => {
          if (typeof window.checkAuthStatus === "function") {
            checkAuthStatus();
          }
          if (typeof window.showLocalScores === "function") {
            showLocalScores();
          }
        }, 1000);
      });
    </script>
  </body>
</html>
