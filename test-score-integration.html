<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>分數整合測試</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background: #000;
        color: #fff;
      }
      .test-section {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #333;
        border-radius: 5px;
      }
      button {
        background: #2121de;
        color: #ffff00;
        border: 2px solid #000;
        padding: 10px 15px;
        margin: 5px;
        cursor: pointer;
        border-radius: 3px;
      }
      button:hover {
        background: #4242ff;
      }
      .result {
        margin: 10px 0;
        padding: 10px;
        background: #111;
        border-radius: 3px;
      }
      .success {
        color: #0f0;
      }
      .error {
        color: #f00;
      }
      .info {
        color: #0ff;
      }
    </style>
  </head>
  <body>
    <h1>🎮 Pac-Map 分數整合測試</h1>

    <div class="test-section">
      <h2>📱 本地分數管理測試</h2>
      <button onclick="testLocalScores()">測試本地分數保存</button>
      <button onclick="showLocalScores()">顯示本地分數</button>
      <button onclick="clearLocalScores()">清除本地分數</button>
      <div id="localScoreResult" class="result"></div>
    </div>

    <div class="test-section">
      <h2>🌐 後端連線測試</h2>
      <button onclick="testBackendConnection()">測試後端連線</button>
      <button onclick="testLeaderboard()">測試排行榜 API</button>
      <div id="backendResult" class="result"></div>
    </div>

    <div class="test-section">
      <h2>🔐 認證狀態測試</h2>
      <button onclick="checkAuthStatus()">檢查登入狀態</button>
      <button onclick="simulateLogin()">模擬登入狀態</button>
      <button onclick="simulateLogout()">模擬登出</button>
      <div id="authResult" class="result"></div>
    </div>

    <div class="test-section">
      <h2>🎯 整合功能測試</h2>
      <button onclick="simulateGameEnd()">模擬遊戲結束</button>
      <button onclick="testMigrationPrompt()">測試遷移提示</button>
      <div id="integrationResult" class="result"></div>
    </div>

    <script>
      // 模擬本地分數管理功能
      function getLocalScores() {
        try {
          const scores = localStorage.getItem("pac_map_local_scores");
          return scores ? JSON.parse(scores) : [];
        } catch (error) {
          console.error("讀取本地分數失敗:", error);
          return [];
        }
      }

      function saveLocalScore(scoreData) {
        try {
          const scores = getLocalScores();
          const newScore = {
            ...scoreData,
            id: Date.now(),
            created_at: new Date().toISOString(),
            is_local: true,
          };

          scores.push(newScore);
          scores.sort((a, b) => b.score - a.score);
          if (scores.length > 20) {
            scores.splice(20);
          }

          localStorage.setItem("pac_map_local_scores", JSON.stringify(scores));
          return newScore;
        } catch (error) {
          console.error("保存本地分數失敗:", error);
          return null;
        }
      }

      // 測試函數
      function testLocalScores() {
        const result = document.getElementById("localScoreResult");

        // 創建測試分數
        const testScore = {
          score: Math.floor(Math.random() * 10000) + 1000,
          level: Math.floor(Math.random() * 5) + 1,
          map_index: Math.floor(Math.random() * 3),
          survival_time: Math.floor(Math.random() * 600) + 60,
          dots_collected: Math.floor(Math.random() * 100) + 50,
          ghosts_eaten: Math.floor(Math.random() * 10),
        };

        const saved = saveLocalScore(testScore);
        if (saved) {
          result.innerHTML = `<span class="success">✅ 本地分數保存成功！</span><br>
                    分數: ${saved.score}, 等級: ${saved.level}, 地圖: ${saved.map_index}`;
        } else {
          result.innerHTML = `<span class="error">❌ 本地分數保存失敗</span>`;
        }
      }

      function showLocalScores() {
        const result = document.getElementById("localScoreResult");
        const scores = getLocalScores();

        if (scores.length === 0) {
          result.innerHTML = `<span class="info">ℹ️ 沒有本地分數記錄</span>`;
        } else {
          let html = `<span class="success">📊 本地分數記錄 (${scores.length} 筆):</span><br>`;
          scores.slice(0, 5).forEach((score, index) => {
            html += `${index + 1}. ${score.score} 分 (等級 ${score.level})<br>`;
          });
          result.innerHTML = html;
        }
      }

      function clearLocalScores() {
        localStorage.removeItem("pac_map_local_scores");
        document.getElementById(
          "localScoreResult"
        ).innerHTML = `<span class="info">🗑️ 本地分數記錄已清除</span>`;
      }

      async function testBackendConnection() {
        const result = document.getElementById("backendResult");
        result.innerHTML = `<span class="info">🔄 正在測試後端連線...</span>`;

        // 動態檢測 API 地址
        const getApiUrl = () => {
          if (
            window.location.hostname === "localhost" ||
            window.location.hostname === "127.0.0.1"
          ) {
            return "http://localhost:8000";
          }
          return `${window.location.protocol}//${window.location.hostname}:8000`;
        };

        const apiUrl = getApiUrl();

        try {
          const response = await fetch(`${apiUrl}/health`);
          if (response.ok) {
            const data = await response.json();
            result.innerHTML = `<span class="success">✅ 後端連線正常</span><br>
                        狀態: ${data.status}`;
          } else {
            result.innerHTML = `<span class="error">❌ 後端回應錯誤: ${response.status}</span>`;
          }
        } catch (error) {
          result.innerHTML = `<span class="error">❌ 後端連線失敗: ${error.message}</span><br>
                    <small>請確保後端伺服器正在運行 (uv run start_server.py)</small>`;
        }
      }

      async function testLeaderboard() {
        const result = document.getElementById("backendResult");
        result.innerHTML = `<span class="info">🔄 正在測試排行榜 API...</span>`;

        // 使用相同的 API 地址檢測邏輯
        const getApiUrl = () => {
          if (
            window.location.hostname === "localhost" ||
            window.location.hostname === "127.0.0.1"
          ) {
            return "http://localhost:8000";
          }
          return `${window.location.protocol}//${window.location.hostname}:8000`;
        };

        const apiUrl = getApiUrl();

        try {
          const response = await fetch(`${apiUrl}/game/leaderboard?limit=5`);
          if (response.ok) {
            const data = await response.json();
            if (data.success && data.data.length > 0) {
              let html = `<span class="success">✅ 排行榜 API 正常</span><br>`;
              data.data.forEach((entry, index) => {
                html += `${entry.rank}. ${entry.user_name} - ${entry.score} 分<br>`;
              });
              result.innerHTML = html;
            } else {
              result.innerHTML = `<span class="info">ℹ️ 排行榜 API 正常，但暫無記錄</span>`;
            }
          } else {
            result.innerHTML = `<span class="error">❌ 排行榜 API 錯誤: ${response.status}</span>`;
          }
        } catch (error) {
          result.innerHTML = `<span class="error">❌ 排行榜 API 失敗: ${error.message}</span>`;
        }
      }

      function checkAuthStatus() {
        const result = document.getElementById("authResult");
        const user = localStorage.getItem("pac_map_user");
        const token = localStorage.getItem("pac_map_token");

        if (user && token) {
          try {
            const userData = JSON.parse(user);
            result.innerHTML = `<span class="success">✅ 用戶已登入</span><br>
                        用戶: ${userData.name}<br>
                        Token: ${token.substring(0, 20)}...`;
          } catch (error) {
            result.innerHTML = `<span class="error">❌ 登入資料損壞</span>`;
          }
        } else {
          result.innerHTML = `<span class="info">ℹ️ 用戶未登入</span>`;
        }
      }

      function simulateLogin() {
        const mockUser = {
          id: 999,
          name: "測試用戶",
          email: "test@example.com",
          picture: "https://via.placeholder.com/50",
        };
        const mockToken = "mock_jwt_token_" + Date.now();

        localStorage.setItem("pac_map_user", JSON.stringify(mockUser));
        localStorage.setItem("pac_map_token", mockToken);

        document.getElementById(
          "authResult"
        ).innerHTML = `<span class="success">✅ 模擬登入成功</span><br>用戶: ${mockUser.name}`;
      }

      function simulateLogout() {
        localStorage.removeItem("pac_map_user");
        localStorage.removeItem("pac_map_token");

        document.getElementById(
          "authResult"
        ).innerHTML = `<span class="info">🚪 模擬登出成功</span>`;
      }

      function simulateGameEnd() {
        const result = document.getElementById("integrationResult");
        const isLoggedIn = !!(
          localStorage.getItem("pac_map_user") &&
          localStorage.getItem("pac_map_token")
        );

        const mockGameData = {
          score: Math.floor(Math.random() * 5000) + 2000,
          level: 3,
          map_index: 1,
          survival_time: 245,
          dots_collected: 67,
          ghosts_eaten: 4,
        };

        if (isLoggedIn) {
          result.innerHTML = `<span class="success">🎮 模擬遊戲結束 (已登入)</span><br>
                    分數: ${mockGameData.score}<br>
                    ➡️ 應該提交到後端<br>
                    <small>實際遊戲中會調用 submitScoreToBackend()</small>`;
        } else {
          const saved = saveLocalScore(mockGameData);
          result.innerHTML = `<span class="info">🎮 模擬遊戲結束 (未登入)</span><br>
                    分數: ${mockGameData.score}<br>
                    ➡️ 已保存到本地<br>
                    ${
                      mockGameData.score > 3000
                        ? "🏆 高分！應該顯示登入提示"
                        : ""
                    }`;
        }
      }

      function testMigrationPrompt() {
        const result = document.getElementById("integrationResult");
        const localScores = getLocalScores();

        if (localScores.length === 0) {
          // 創建一些測試分數
          for (let i = 0; i < 3; i++) {
            saveLocalScore({
              score: Math.floor(Math.random() * 3000) + 1000,
              level: i + 1,
              map_index: i % 3,
              survival_time: 180 + i * 30,
              dots_collected: 40 + i * 10,
              ghosts_eaten: i * 2,
            });
          }
        }

        const scores = getLocalScores();
        result.innerHTML = `<span class="info">🔄 模擬遷移提示</span><br>
                發現 ${scores.length} 個本地記錄<br>
                ➡️ 實際遊戲中會顯示遷移對話框<br>
                <small>用戶登入後會自動觸發</small>`;
      }

      // 頁面載入時顯示狀態
      window.addEventListener("load", () => {
        checkAuthStatus();
        showLocalScores();
      });
    </script>
  </body>
</html>
