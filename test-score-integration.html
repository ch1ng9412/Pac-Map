<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>åˆ†æ•¸æ•´åˆæ¸¬è©¦</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background: #000;
        color: #fff;
      }
      .test-section {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #333;
        border-radius: 5px;
      }
      button {
        background: #2121de;
        color: #ffff00;
        border: 2px solid #000;
        padding: 10px 15px;
        margin: 5px;
        cursor: pointer;
        border-radius: 3px;
      }
      button:hover {
        background: #4242ff;
      }
      .result {
        margin: 10px 0;
        padding: 10px;
        background: #111;
        border-radius: 3px;
      }
      .success {
        color: #0f0;
      }
      .error {
        color: #f00;
      }
      .info {
        color: #0ff;
      }
    </style>
  </head>
  <body>
    <h1>ğŸ® Pac-Map åˆ†æ•¸æ•´åˆæ¸¬è©¦</h1>

    <div class="test-section">
      <h2>ğŸ“± æœ¬åœ°åˆ†æ•¸ç®¡ç†æ¸¬è©¦</h2>
      <button onclick="testLocalScores()">æ¸¬è©¦æœ¬åœ°åˆ†æ•¸ä¿å­˜</button>
      <button onclick="showLocalScores()">é¡¯ç¤ºæœ¬åœ°åˆ†æ•¸</button>
      <button onclick="clearLocalScores()">æ¸…é™¤æœ¬åœ°åˆ†æ•¸</button>
      <div id="localScoreResult" class="result"></div>
    </div>

    <div class="test-section">
      <h2>ğŸŒ å¾Œç«¯é€£ç·šæ¸¬è©¦</h2>
      <button onclick="testBackendConnection()">æ¸¬è©¦å¾Œç«¯é€£ç·š</button>
      <button onclick="testLeaderboard()">æ¸¬è©¦æ’è¡Œæ¦œ API</button>
      <div id="backendResult" class="result"></div>
    </div>

    <div class="test-section">
      <h2>ğŸ” èªè­‰ç‹€æ…‹æ¸¬è©¦</h2>
      <button onclick="checkAuthStatus()">æª¢æŸ¥ç™»å…¥ç‹€æ…‹</button>
      <button onclick="simulateLogin()">æ¨¡æ“¬ç™»å…¥ç‹€æ…‹</button>
      <button onclick="simulateLogout()">æ¨¡æ“¬ç™»å‡º</button>
      <div id="authResult" class="result"></div>
    </div>

    <div class="test-section">
      <h2>ğŸ¯ æ•´åˆåŠŸèƒ½æ¸¬è©¦</h2>
      <button onclick="simulateGameEnd()">æ¨¡æ“¬éŠæˆ²çµæŸ</button>
      <button onclick="testMigrationPrompt()">æ¸¬è©¦é·ç§»æç¤º</button>
      <div id="integrationResult" class="result"></div>
    </div>

    <script>
      // æ¨¡æ“¬æœ¬åœ°åˆ†æ•¸ç®¡ç†åŠŸèƒ½
      function getLocalScores() {
        try {
          const scores = localStorage.getItem("pac_map_local_scores");
          return scores ? JSON.parse(scores) : [];
        } catch (error) {
          console.error("è®€å–æœ¬åœ°åˆ†æ•¸å¤±æ•—:", error);
          return [];
        }
      }

      function saveLocalScore(scoreData) {
        try {
          const scores = getLocalScores();
          const newScore = {
            ...scoreData,
            id: Date.now(),
            created_at: new Date().toISOString(),
            is_local: true,
          };

          scores.push(newScore);
          scores.sort((a, b) => b.score - a.score);
          if (scores.length > 20) {
            scores.splice(20);
          }

          localStorage.setItem("pac_map_local_scores", JSON.stringify(scores));
          return newScore;
        } catch (error) {
          console.error("ä¿å­˜æœ¬åœ°åˆ†æ•¸å¤±æ•—:", error);
          return null;
        }
      }

      // æ¸¬è©¦å‡½æ•¸
      function testLocalScores() {
        const result = document.getElementById("localScoreResult");

        // å‰µå»ºæ¸¬è©¦åˆ†æ•¸
        const testScore = {
          score: Math.floor(Math.random() * 10000) + 1000,
          level: Math.floor(Math.random() * 5) + 1,
          map_index: Math.floor(Math.random() * 3),
          survival_time: Math.floor(Math.random() * 600) + 60,
          dots_collected: Math.floor(Math.random() * 100) + 50,
          ghosts_eaten: Math.floor(Math.random() * 10),
        };

        const saved = saveLocalScore(testScore);
        if (saved) {
          result.innerHTML = `<span class="success">âœ… æœ¬åœ°åˆ†æ•¸ä¿å­˜æˆåŠŸï¼</span><br>
                    åˆ†æ•¸: ${saved.score}, ç­‰ç´š: ${saved.level}, åœ°åœ–: ${saved.map_index}`;
        } else {
          result.innerHTML = `<span class="error">âŒ æœ¬åœ°åˆ†æ•¸ä¿å­˜å¤±æ•—</span>`;
        }
      }

      function showLocalScores() {
        const result = document.getElementById("localScoreResult");
        const scores = getLocalScores();

        if (scores.length === 0) {
          result.innerHTML = `<span class="info">â„¹ï¸ æ²’æœ‰æœ¬åœ°åˆ†æ•¸è¨˜éŒ„</span>`;
        } else {
          let html = `<span class="success">ğŸ“Š æœ¬åœ°åˆ†æ•¸è¨˜éŒ„ (${scores.length} ç­†):</span><br>`;
          scores.slice(0, 5).forEach((score, index) => {
            html += `${index + 1}. ${score.score} åˆ† (ç­‰ç´š ${score.level})<br>`;
          });
          result.innerHTML = html;
        }
      }

      function clearLocalScores() {
        localStorage.removeItem("pac_map_local_scores");
        document.getElementById(
          "localScoreResult"
        ).innerHTML = `<span class="info">ğŸ—‘ï¸ æœ¬åœ°åˆ†æ•¸è¨˜éŒ„å·²æ¸…é™¤</span>`;
      }

      async function testBackendConnection() {
        const result = document.getElementById("backendResult");
        result.innerHTML = `<span class="info">ğŸ”„ æ­£åœ¨æ¸¬è©¦å¾Œç«¯é€£ç·š...</span>`;

        // å‹•æ…‹æª¢æ¸¬ API åœ°å€
        const getApiUrl = () => {
          if (
            window.location.hostname === "localhost" ||
            window.location.hostname === "127.0.0.1"
          ) {
            return "http://localhost:8000";
          }
          return `${window.location.protocol}//${window.location.hostname}:8000`;
        };

        const apiUrl = getApiUrl();

        try {
          const response = await fetch(`${apiUrl}/health`);
          if (response.ok) {
            const data = await response.json();
            result.innerHTML = `<span class="success">âœ… å¾Œç«¯é€£ç·šæ­£å¸¸</span><br>
                        ç‹€æ…‹: ${data.status}`;
          } else {
            result.innerHTML = `<span class="error">âŒ å¾Œç«¯å›æ‡‰éŒ¯èª¤: ${response.status}</span>`;
          }
        } catch (error) {
          result.innerHTML = `<span class="error">âŒ å¾Œç«¯é€£ç·šå¤±æ•—: ${error.message}</span><br>
                    <small>è«‹ç¢ºä¿å¾Œç«¯ä¼ºæœå™¨æ­£åœ¨é‹è¡Œ (uv run start_server.py)</small>`;
        }
      }

      async function testLeaderboard() {
        const result = document.getElementById("backendResult");
        result.innerHTML = `<span class="info">ğŸ”„ æ­£åœ¨æ¸¬è©¦æ’è¡Œæ¦œ API...</span>`;

        // ä½¿ç”¨ç›¸åŒçš„ API åœ°å€æª¢æ¸¬é‚è¼¯
        const getApiUrl = () => {
          if (
            window.location.hostname === "localhost" ||
            window.location.hostname === "127.0.0.1"
          ) {
            return "http://localhost:8000";
          }
          return `${window.location.protocol}//${window.location.hostname}:8000`;
        };

        const apiUrl = getApiUrl();

        try {
          const response = await fetch(`${apiUrl}/game/leaderboard?limit=5`);
          if (response.ok) {
            const data = await response.json();
            if (data.success && data.data.length > 0) {
              let html = `<span class="success">âœ… æ’è¡Œæ¦œ API æ­£å¸¸</span><br>`;
              data.data.forEach((entry, index) => {
                html += `${entry.rank}. ${entry.user_name} - ${entry.score} åˆ†<br>`;
              });
              result.innerHTML = html;
            } else {
              result.innerHTML = `<span class="info">â„¹ï¸ æ’è¡Œæ¦œ API æ­£å¸¸ï¼Œä½†æš«ç„¡è¨˜éŒ„</span>`;
            }
          } else {
            result.innerHTML = `<span class="error">âŒ æ’è¡Œæ¦œ API éŒ¯èª¤: ${response.status}</span>`;
          }
        } catch (error) {
          result.innerHTML = `<span class="error">âŒ æ’è¡Œæ¦œ API å¤±æ•—: ${error.message}</span>`;
        }
      }

      function checkAuthStatus() {
        const result = document.getElementById("authResult");
        const user = localStorage.getItem("pac_map_user");
        const token = localStorage.getItem("pac_map_token");

        if (user && token) {
          try {
            const userData = JSON.parse(user);
            result.innerHTML = `<span class="success">âœ… ç”¨æˆ¶å·²ç™»å…¥</span><br>
                        ç”¨æˆ¶: ${userData.name}<br>
                        Token: ${token.substring(0, 20)}...`;
          } catch (error) {
            result.innerHTML = `<span class="error">âŒ ç™»å…¥è³‡æ–™æå£</span>`;
          }
        } else {
          result.innerHTML = `<span class="info">â„¹ï¸ ç”¨æˆ¶æœªç™»å…¥</span>`;
        }
      }

      function simulateLogin() {
        const mockUser = {
          id: 999,
          name: "æ¸¬è©¦ç”¨æˆ¶",
          email: "test@example.com",
          picture: "https://via.placeholder.com/50",
        };
        const mockToken = "mock_jwt_token_" + Date.now();

        localStorage.setItem("pac_map_user", JSON.stringify(mockUser));
        localStorage.setItem("pac_map_token", mockToken);

        document.getElementById(
          "authResult"
        ).innerHTML = `<span class="success">âœ… æ¨¡æ“¬ç™»å…¥æˆåŠŸ</span><br>ç”¨æˆ¶: ${mockUser.name}`;
      }

      function simulateLogout() {
        localStorage.removeItem("pac_map_user");
        localStorage.removeItem("pac_map_token");

        document.getElementById(
          "authResult"
        ).innerHTML = `<span class="info">ğŸšª æ¨¡æ“¬ç™»å‡ºæˆåŠŸ</span>`;
      }

      function simulateGameEnd() {
        const result = document.getElementById("integrationResult");
        const isLoggedIn = !!(
          localStorage.getItem("pac_map_user") &&
          localStorage.getItem("pac_map_token")
        );

        const mockGameData = {
          score: Math.floor(Math.random() * 5000) + 2000,
          level: 3,
          map_index: 1,
          survival_time: 245,
          dots_collected: 67,
          ghosts_eaten: 4,
        };

        if (isLoggedIn) {
          result.innerHTML = `<span class="success">ğŸ® æ¨¡æ“¬éŠæˆ²çµæŸ (å·²ç™»å…¥)</span><br>
                    åˆ†æ•¸: ${mockGameData.score}<br>
                    â¡ï¸ æ‡‰è©²æäº¤åˆ°å¾Œç«¯<br>
                    <small>å¯¦éš›éŠæˆ²ä¸­æœƒèª¿ç”¨ submitScoreToBackend()</small>`;
        } else {
          const saved = saveLocalScore(mockGameData);
          result.innerHTML = `<span class="info">ğŸ® æ¨¡æ“¬éŠæˆ²çµæŸ (æœªç™»å…¥)</span><br>
                    åˆ†æ•¸: ${mockGameData.score}<br>
                    â¡ï¸ å·²ä¿å­˜åˆ°æœ¬åœ°<br>
                    ${
                      mockGameData.score > 3000
                        ? "ğŸ† é«˜åˆ†ï¼æ‡‰è©²é¡¯ç¤ºç™»å…¥æç¤º"
                        : ""
                    }`;
        }
      }

      function testMigrationPrompt() {
        const result = document.getElementById("integrationResult");
        const localScores = getLocalScores();

        if (localScores.length === 0) {
          // å‰µå»ºä¸€äº›æ¸¬è©¦åˆ†æ•¸
          for (let i = 0; i < 3; i++) {
            saveLocalScore({
              score: Math.floor(Math.random() * 3000) + 1000,
              level: i + 1,
              map_index: i % 3,
              survival_time: 180 + i * 30,
              dots_collected: 40 + i * 10,
              ghosts_eaten: i * 2,
            });
          }
        }

        const scores = getLocalScores();
        result.innerHTML = `<span class="info">ğŸ”„ æ¨¡æ“¬é·ç§»æç¤º</span><br>
                ç™¼ç¾ ${scores.length} å€‹æœ¬åœ°è¨˜éŒ„<br>
                â¡ï¸ å¯¦éš›éŠæˆ²ä¸­æœƒé¡¯ç¤ºé·ç§»å°è©±æ¡†<br>
                <small>ç”¨æˆ¶ç™»å…¥å¾Œæœƒè‡ªå‹•è§¸ç™¼</small>`;
      }

      // é é¢è¼‰å…¥æ™‚é¡¯ç¤ºç‹€æ…‹
      window.addEventListener("load", () => {
        checkAuthStatus();
        showLocalScores();
      });
    </script>
  </body>
</html>
