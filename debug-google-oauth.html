<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Google OAuth 詳細診斷</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 20px auto;
        padding: 20px;
        line-height: 1.6;
      }
      .section {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 8px;
        background: #f9f9f9;
      }
      .error {
        background: #ffe6e6;
        border-color: #ff9999;
      }
      .success {
        background: #e6ffe6;
        border-color: #99ff99;
      }
      .warning {
        background: #fff3cd;
        border-color: #ffeaa7;
      }
      .info {
        background: #e6f3ff;
        border-color: #99ccff;
      }

      pre {
        background: #f4f4f4;
        padding: 10px;
        border-radius: 4px;
        overflow-x: auto;
        white-space: pre-wrap;
      }

      button {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
      }

      button:hover {
        background: #0056b3;
      }

      .test-button {
        background: #28a745;
      }

      .test-button:hover {
        background: #1e7e34;
      }
    </style>
  </head>
  <body>
    <h1>🔍 Google OAuth 詳細診斷</h1>

    <div class="section info">
      <h2>📋 診斷檢查清單</h2>
      <div id="checkList">
        <div>⏳ 檢查 Google Sign-In SDK 載入...</div>
        <div>⏳ 檢查後端連線...</div>
        <div>⏳ 檢查 Client ID 有效性...</div>
        <div>⏳ 檢查當前頁面 URL...</div>
      </div>
    </div>

    <div class="section">
      <h2>🌐 當前環境資訊</h2>
      <pre id="envInfo">載入中...</pre>
    </div>

    <div class="section">
      <h2>🔑 Google OAuth 設定檢查</h2>
      <pre id="oauthInfo">載入中...</pre>
    </div>

    <div class="section">
      <h2>🧪 手動測試區域</h2>
      <p>這裡使用不同的方式來測試 Google 登入：</p>

      <h3>方法 1: 標準 Google Sign-In 按鈕</h3>
      <div id="standardSignIn">
        <!-- 這裡會動態插入 Google Sign-In 按鈕 -->
      </div>

      <h3>方法 2: 程式化登入</h3>
      <button onclick="testProgrammaticLogin()" class="test-button">
        測試程式化登入
      </button>

      <h3>方法 3: 彈出視窗登入</h3>
      <button onclick="testPopupLogin()" class="test-button">
        測試彈出視窗登入
      </button>
    </div>

    <div class="section">
      <h2>📊 測試結果</h2>
      <div id="testResults">
        <p>等待測試...</p>
      </div>
    </div>

    <div class="section">
      <h2>🔧 建議的解決方案</h2>
      <div id="solutions">
        <h3>🔧 常見問題解決方案</h3>

        <h4>1. "missing_client_id" 錯誤</h4>
        <p><strong>原因：</strong>Google Sign-In 沒有正確接收到 Client ID</p>
        <p>
          <strong>解決：</strong>確保 HTML 中的 data-client_id
          正確設定，或在程式化調用時正確初始化
        </p>

        <h4>2. redirect_uri_mismatch 錯誤</h4>
        <p>
          <strong>原因：</strong>Google Cloud Console 中缺少當前頁面的重導向 URI
        </p>
        <p><strong>解決：</strong>在 Google Cloud Console 中添加以下設定：</p>
        <ul>
          <li>
            <strong>已授權的 JavaScript 來源：</strong> <br />•
            http://localhost:5500 <br />• http://127.0.0.1:5500
          </li>
          <li>
            <strong>已授權的重新導向 URI：</strong> <br />•
            http://localhost:5500/debug-google-oauth.html <br />•
            http://localhost:5500/index.html <br />• http://localhost:5500/
            <br />• http://localhost:8000/auth/google/callback
          </li>
        </ul>
        <p>
          <strong>注意：</strong>Google Sign-In for Web
          需要將每個使用登入功能的頁面都加入重導向 URI 清單
        </p>

        <h4>3. 主頁面登入按鈕無反應</h4>
        <p><strong>原因：</strong>JavaScript 載入順序問題或函數未正確暴露</p>
        <p><strong>解決：</strong>檢查瀏覽器控制台是否有錯誤訊息</p>

        <h4>4. CORS 錯誤</h4>
        <p><strong>原因：</strong>後端 CORS 設定不正確</p>
        <p><strong>解決：</strong>確認後端允許來自 localhost:5500 的請求</p>

        <h4>5. 網路請求失敗</h4>
        <p><strong>原因：</strong>後端服務未運行或埠號錯誤</p>
        <p><strong>解決：</strong>確認後端在 http://localhost:8000 正常運行</p>
      </div>
    </div>

    <script>
      let diagnosticResults = {
        googleSDK: false,
        backend: false,
        clientId: false,
        currentURL: window.location.href,
      };

      // 頁面載入時開始診斷
      window.addEventListener("load", async () => {
        await runDiagnostics();
        updateEnvironmentInfo();
        updateOAuthInfo();
        setupGoogleSignIn();
      });

      async function runDiagnostics() {
        const checkList = document.getElementById("checkList");

        // 1. 檢查 Google SDK
        await new Promise((resolve) => {
          const checkGoogle = () => {
            if (typeof google !== "undefined" && google.accounts) {
              diagnosticResults.googleSDK = true;
              updateCheckItem(0, "✅ Google Sign-In SDK 已載入");
              resolve();
            } else {
              setTimeout(checkGoogle, 100);
            }
          };
          checkGoogle();

          // 10秒後超時
          setTimeout(() => {
            if (!diagnosticResults.googleSDK) {
              updateCheckItem(0, "❌ Google Sign-In SDK 載入失敗");
              resolve();
            }
          }, 10000);
        });

        // 2. 檢查後端
        try {
          const response = await fetch("http://localhost:8000/health");
          if (response.ok) {
            diagnosticResults.backend = true;
            updateCheckItem(1, "✅ 後端連線正常");
          } else {
            updateCheckItem(1, `❌ 後端回應錯誤: ${response.status}`);
          }
        } catch (error) {
          updateCheckItem(1, `❌ 後端連線失敗: ${error.message}`);
        }

        // 3. 檢查 Client ID
        const clientId =
          "225638092115-2rjm7fr2me7k9k420v92m329sk6s3ho0.apps.googleusercontent.com";
        if (clientId && clientId.endsWith(".apps.googleusercontent.com")) {
          diagnosticResults.clientId = true;
          updateCheckItem(2, "✅ Client ID 格式正確");
        } else {
          updateCheckItem(2, "❌ Client ID 格式錯誤");
        }

        // 4. 檢查當前 URL
        updateCheckItem(3, `✅ 當前頁面: ${window.location.href}`);
      }

      function updateCheckItem(index, text) {
        const checkList = document.getElementById("checkList");
        const items = checkList.children;
        if (items[index]) {
          items[index].textContent = text;
        }
      }

      function updateEnvironmentInfo() {
        const envInfo = document.getElementById("envInfo");
        envInfo.textContent = JSON.stringify(
          {
            userAgent: navigator.userAgent,
            currentURL: window.location.href,
            referrer: document.referrer,
            cookiesEnabled: navigator.cookieEnabled,
            language: navigator.language,
            platform: navigator.platform,
            timestamp: new Date().toISOString(),
          },
          null,
          2
        );
      }

      function updateOAuthInfo() {
        const oauthInfo = document.getElementById("oauthInfo");
        oauthInfo.textContent = JSON.stringify(
          {
            clientId:
              "225638092115-2rjm7fr2me7k9k420v92m329sk6s3ho0.apps.googleusercontent.com",
            redirectURI: "http://localhost:8000/auth/google/callback",
            currentDomain: window.location.hostname,
            currentPort: window.location.port,
            currentProtocol: window.location.protocol,
            googleSDKLoaded: typeof google !== "undefined",
            diagnosticResults: diagnosticResults,
          },
          null,
          2
        );
      }

      function setupGoogleSignIn() {
        if (!diagnosticResults.googleSDK) {
          document.getElementById("standardSignIn").innerHTML =
            '<p style="color: red;">Google SDK 未載入，無法顯示登入按鈕</p>';
          return;
        }

        // 創建標準登入按鈕
        const signInDiv = document.createElement("div");
        signInDiv.innerHTML = `
                <div id="g_id_onload"
                     data-client_id="225638092115-2rjm7fr2me7k9k420v92m329sk6s3ho0.apps.googleusercontent.com"
                     data-callback="handleStandardLogin"
                     data-auto_prompt="false">
                </div>
                <div class="g_id_signin" data-type="standard"></div>
            `;
        document.getElementById("standardSignIn").appendChild(signInDiv);
      }

      // 標準登入回調
      window.handleStandardLogin = function (response) {
        logTestResult("標準登入", "收到回應", response);
        processGoogleResponse(response, "標準登入");
      };

      // 程式化登入測試
      function testProgrammaticLogin() {
        if (!diagnosticResults.googleSDK) {
          logTestResult("程式化登入", "失敗", "Google SDK 未載入");
          return;
        }

        try {
          // 先初始化 Google ID 服務
          const clientId =
            "225638092115-2rjm7fr2me7k9k420v92m329sk6s3ho0.apps.googleusercontent.com";

          google.accounts.id.initialize({
            client_id: clientId,
            callback: (response) => {
              logTestResult("程式化登入", "登入回調", response);
              processGoogleResponse(response, "程式化登入");
            },
          });

          google.accounts.id.prompt((notification) => {
            logTestResult("程式化登入", "提示回調", notification);
          });
        } catch (error) {
          logTestResult("程式化登入", "錯誤", error.message);
        }
      }

      // 彈出視窗登入測試
      function testPopupLogin() {
        logTestResult("彈出視窗登入", "開始", "嘗試開啟彈出視窗...");

        // 使用傳統的 OAuth 流程
        const clientId =
          "225638092115-2rjm7fr2me7k9k420v92m329sk6s3ho0.apps.googleusercontent.com";
        const redirectUri = encodeURIComponent(window.location.href);
        const scope = encodeURIComponent("openid email profile");

        const authUrl =
          `https://accounts.google.com/o/oauth2/v2/auth?` +
          `client_id=${clientId}&` +
          `redirect_uri=${redirectUri}&` +
          `scope=${scope}&` +
          `response_type=code&` +
          `access_type=offline&` +
          `prompt=consent`;

        const popup = window.open(
          authUrl,
          "googleAuth",
          "width=500,height=600"
        );

        if (popup) {
          logTestResult("彈出視窗登入", "成功", "彈出視窗已開啟");
        } else {
          logTestResult("彈出視窗登入", "失敗", "彈出視窗被阻擋");
        }
      }

      async function processGoogleResponse(response, method) {
        try {
          logTestResult(method, "處理回應", "發送到後端驗證...");

          const loginResponse = await fetch(
            "http://localhost:8000/auth/google/login",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                id_token: response.credential,
              }),
            }
          );

          if (!loginResponse.ok) {
            throw new Error(
              `HTTP ${loginResponse.status}: ${await loginResponse.text()}`
            );
          }

          const data = await loginResponse.json();
          logTestResult(method, "成功", data);
        } catch (error) {
          logTestResult(method, "失敗", error.message);
        }
      }

      function logTestResult(method, status, data) {
        const results = document.getElementById("testResults");
        const timestamp = new Date().toLocaleTimeString();

        const resultDiv = document.createElement("div");
        resultDiv.innerHTML = `
                <strong>[${timestamp}] ${method} - ${status}:</strong>
                <pre>${
                  typeof data === "object"
                    ? JSON.stringify(data, null, 2)
                    : data
                }</pre>
            `;

        results.appendChild(resultDiv);
        results.scrollTop = results.scrollHeight;
      }
    </script>

    <!-- 載入 Google Sign-In SDK -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
  </body>
</html>
