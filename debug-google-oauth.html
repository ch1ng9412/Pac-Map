<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Google OAuth è©³ç´°è¨ºæ–·</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 20px auto;
        padding: 20px;
        line-height: 1.6;
      }
      .section {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 8px;
        background: #f9f9f9;
      }
      .error {
        background: #ffe6e6;
        border-color: #ff9999;
      }
      .success {
        background: #e6ffe6;
        border-color: #99ff99;
      }
      .warning {
        background: #fff3cd;
        border-color: #ffeaa7;
      }
      .info {
        background: #e6f3ff;
        border-color: #99ccff;
      }

      pre {
        background: #f4f4f4;
        padding: 10px;
        border-radius: 4px;
        overflow-x: auto;
        white-space: pre-wrap;
      }

      button {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
      }

      button:hover {
        background: #0056b3;
      }

      .test-button {
        background: #28a745;
      }

      .test-button:hover {
        background: #1e7e34;
      }
    </style>
  </head>
  <body>
    <h1>ğŸ” Google OAuth è©³ç´°è¨ºæ–·</h1>

    <div class="section info">
      <h2>ğŸ“‹ è¨ºæ–·æª¢æŸ¥æ¸…å–®</h2>
      <div id="checkList">
        <div>â³ æª¢æŸ¥ Google Sign-In SDK è¼‰å…¥...</div>
        <div>â³ æª¢æŸ¥å¾Œç«¯é€£ç·š...</div>
        <div>â³ æª¢æŸ¥ Client ID æœ‰æ•ˆæ€§...</div>
        <div>â³ æª¢æŸ¥ç•¶å‰é é¢ URL...</div>
      </div>
    </div>

    <div class="section">
      <h2>ğŸŒ ç•¶å‰ç’°å¢ƒè³‡è¨Š</h2>
      <pre id="envInfo">è¼‰å…¥ä¸­...</pre>
    </div>

    <div class="section">
      <h2>ğŸ”‘ Google OAuth è¨­å®šæª¢æŸ¥</h2>
      <pre id="oauthInfo">è¼‰å…¥ä¸­...</pre>
    </div>

    <div class="section">
      <h2>ğŸ§ª æ‰‹å‹•æ¸¬è©¦å€åŸŸ</h2>
      <p>é€™è£¡ä½¿ç”¨ä¸åŒçš„æ–¹å¼ä¾†æ¸¬è©¦ Google ç™»å…¥ï¼š</p>

      <h3>æ–¹æ³• 1: æ¨™æº– Google Sign-In æŒ‰éˆ•</h3>
      <div id="standardSignIn">
        <!-- é€™è£¡æœƒå‹•æ…‹æ’å…¥ Google Sign-In æŒ‰éˆ• -->
      </div>

      <h3>æ–¹æ³• 2: ç¨‹å¼åŒ–ç™»å…¥</h3>
      <button onclick="testProgrammaticLogin()" class="test-button">
        æ¸¬è©¦ç¨‹å¼åŒ–ç™»å…¥
      </button>

      <h3>æ–¹æ³• 3: å½ˆå‡ºè¦–çª—ç™»å…¥</h3>
      <button onclick="testPopupLogin()" class="test-button">
        æ¸¬è©¦å½ˆå‡ºè¦–çª—ç™»å…¥
      </button>
    </div>

    <div class="section">
      <h2>ğŸ“Š æ¸¬è©¦çµæœ</h2>
      <div id="testResults">
        <p>ç­‰å¾…æ¸¬è©¦...</p>
      </div>
    </div>

    <div class="section">
      <h2>ğŸ”§ å»ºè­°çš„è§£æ±ºæ–¹æ¡ˆ</h2>
      <div id="solutions">
        <h3>ğŸ”§ å¸¸è¦‹å•é¡Œè§£æ±ºæ–¹æ¡ˆ</h3>

        <h4>1. "missing_client_id" éŒ¯èª¤</h4>
        <p><strong>åŸå› ï¼š</strong>Google Sign-In æ²’æœ‰æ­£ç¢ºæ¥æ”¶åˆ° Client ID</p>
        <p>
          <strong>è§£æ±ºï¼š</strong>ç¢ºä¿ HTML ä¸­çš„ data-client_id
          æ­£ç¢ºè¨­å®šï¼Œæˆ–åœ¨ç¨‹å¼åŒ–èª¿ç”¨æ™‚æ­£ç¢ºåˆå§‹åŒ–
        </p>

        <h4>2. redirect_uri_mismatch éŒ¯èª¤</h4>
        <p>
          <strong>åŸå› ï¼š</strong>Google Cloud Console ä¸­ç¼ºå°‘ç•¶å‰é é¢çš„é‡å°å‘ URI
        </p>
        <p><strong>è§£æ±ºï¼š</strong>åœ¨ Google Cloud Console ä¸­æ·»åŠ ä»¥ä¸‹è¨­å®šï¼š</p>
        <ul>
          <li>
            <strong>å·²æˆæ¬Šçš„ JavaScript ä¾†æºï¼š</strong> <br />â€¢
            http://localhost:5500 <br />â€¢ http://127.0.0.1:5500
          </li>
          <li>
            <strong>å·²æˆæ¬Šçš„é‡æ–°å°å‘ URIï¼š</strong> <br />â€¢
            http://localhost:5500/debug-google-oauth.html <br />â€¢
            http://localhost:5500/index.html <br />â€¢ http://localhost:5500/
            <br />â€¢ http://localhost:8000/auth/google/callback
          </li>
        </ul>
        <p>
          <strong>æ³¨æ„ï¼š</strong>Google Sign-In for Web
          éœ€è¦å°‡æ¯å€‹ä½¿ç”¨ç™»å…¥åŠŸèƒ½çš„é é¢éƒ½åŠ å…¥é‡å°å‘ URI æ¸…å–®
        </p>

        <h4>3. ä¸»é é¢ç™»å…¥æŒ‰éˆ•ç„¡åæ‡‰</h4>
        <p><strong>åŸå› ï¼š</strong>JavaScript è¼‰å…¥é †åºå•é¡Œæˆ–å‡½æ•¸æœªæ­£ç¢ºæš´éœ²</p>
        <p><strong>è§£æ±ºï¼š</strong>æª¢æŸ¥ç€è¦½å™¨æ§åˆ¶å°æ˜¯å¦æœ‰éŒ¯èª¤è¨Šæ¯</p>

        <h4>4. CORS éŒ¯èª¤</h4>
        <p><strong>åŸå› ï¼š</strong>å¾Œç«¯ CORS è¨­å®šä¸æ­£ç¢º</p>
        <p><strong>è§£æ±ºï¼š</strong>ç¢ºèªå¾Œç«¯å…è¨±ä¾†è‡ª localhost:5500 çš„è«‹æ±‚</p>

        <h4>5. ç¶²è·¯è«‹æ±‚å¤±æ•—</h4>
        <p><strong>åŸå› ï¼š</strong>å¾Œç«¯æœå‹™æœªé‹è¡Œæˆ–åŸ è™ŸéŒ¯èª¤</p>
        <p><strong>è§£æ±ºï¼š</strong>ç¢ºèªå¾Œç«¯åœ¨ http://localhost:8000 æ­£å¸¸é‹è¡Œ</p>
      </div>
    </div>

    <script>
      let diagnosticResults = {
        googleSDK: false,
        backend: false,
        clientId: false,
        currentURL: window.location.href,
      };

      // é é¢è¼‰å…¥æ™‚é–‹å§‹è¨ºæ–·
      window.addEventListener("load", async () => {
        await runDiagnostics();
        updateEnvironmentInfo();
        updateOAuthInfo();
        setupGoogleSignIn();
      });

      async function runDiagnostics() {
        const checkList = document.getElementById("checkList");

        // 1. æª¢æŸ¥ Google SDK
        await new Promise((resolve) => {
          const checkGoogle = () => {
            if (typeof google !== "undefined" && google.accounts) {
              diagnosticResults.googleSDK = true;
              updateCheckItem(0, "âœ… Google Sign-In SDK å·²è¼‰å…¥");
              resolve();
            } else {
              setTimeout(checkGoogle, 100);
            }
          };
          checkGoogle();

          // 10ç§’å¾Œè¶…æ™‚
          setTimeout(() => {
            if (!diagnosticResults.googleSDK) {
              updateCheckItem(0, "âŒ Google Sign-In SDK è¼‰å…¥å¤±æ•—");
              resolve();
            }
          }, 10000);
        });

        // 2. æª¢æŸ¥å¾Œç«¯
        try {
          const response = await fetch("http://localhost:8000/health");
          if (response.ok) {
            diagnosticResults.backend = true;
            updateCheckItem(1, "âœ… å¾Œç«¯é€£ç·šæ­£å¸¸");
          } else {
            updateCheckItem(1, `âŒ å¾Œç«¯å›æ‡‰éŒ¯èª¤: ${response.status}`);
          }
        } catch (error) {
          updateCheckItem(1, `âŒ å¾Œç«¯é€£ç·šå¤±æ•—: ${error.message}`);
        }

        // 3. æª¢æŸ¥ Client ID
        const clientId =
          "225638092115-2rjm7fr2me7k9k420v92m329sk6s3ho0.apps.googleusercontent.com";
        if (clientId && clientId.endsWith(".apps.googleusercontent.com")) {
          diagnosticResults.clientId = true;
          updateCheckItem(2, "âœ… Client ID æ ¼å¼æ­£ç¢º");
        } else {
          updateCheckItem(2, "âŒ Client ID æ ¼å¼éŒ¯èª¤");
        }

        // 4. æª¢æŸ¥ç•¶å‰ URL
        updateCheckItem(3, `âœ… ç•¶å‰é é¢: ${window.location.href}`);
      }

      function updateCheckItem(index, text) {
        const checkList = document.getElementById("checkList");
        const items = checkList.children;
        if (items[index]) {
          items[index].textContent = text;
        }
      }

      function updateEnvironmentInfo() {
        const envInfo = document.getElementById("envInfo");
        envInfo.textContent = JSON.stringify(
          {
            userAgent: navigator.userAgent,
            currentURL: window.location.href,
            referrer: document.referrer,
            cookiesEnabled: navigator.cookieEnabled,
            language: navigator.language,
            platform: navigator.platform,
            timestamp: new Date().toISOString(),
          },
          null,
          2
        );
      }

      function updateOAuthInfo() {
        const oauthInfo = document.getElementById("oauthInfo");
        oauthInfo.textContent = JSON.stringify(
          {
            clientId:
              "225638092115-2rjm7fr2me7k9k420v92m329sk6s3ho0.apps.googleusercontent.com",
            redirectURI: "http://localhost:8000/auth/google/callback",
            currentDomain: window.location.hostname,
            currentPort: window.location.port,
            currentProtocol: window.location.protocol,
            googleSDKLoaded: typeof google !== "undefined",
            diagnosticResults: diagnosticResults,
          },
          null,
          2
        );
      }

      function setupGoogleSignIn() {
        if (!diagnosticResults.googleSDK) {
          document.getElementById("standardSignIn").innerHTML =
            '<p style="color: red;">Google SDK æœªè¼‰å…¥ï¼Œç„¡æ³•é¡¯ç¤ºç™»å…¥æŒ‰éˆ•</p>';
          return;
        }

        // å‰µå»ºæ¨™æº–ç™»å…¥æŒ‰éˆ•
        const signInDiv = document.createElement("div");
        signInDiv.innerHTML = `
                <div id="g_id_onload"
                     data-client_id="225638092115-2rjm7fr2me7k9k420v92m329sk6s3ho0.apps.googleusercontent.com"
                     data-callback="handleStandardLogin"
                     data-auto_prompt="false">
                </div>
                <div class="g_id_signin" data-type="standard"></div>
            `;
        document.getElementById("standardSignIn").appendChild(signInDiv);
      }

      // æ¨™æº–ç™»å…¥å›èª¿
      window.handleStandardLogin = function (response) {
        logTestResult("æ¨™æº–ç™»å…¥", "æ”¶åˆ°å›æ‡‰", response);
        processGoogleResponse(response, "æ¨™æº–ç™»å…¥");
      };

      // ç¨‹å¼åŒ–ç™»å…¥æ¸¬è©¦
      function testProgrammaticLogin() {
        if (!diagnosticResults.googleSDK) {
          logTestResult("ç¨‹å¼åŒ–ç™»å…¥", "å¤±æ•—", "Google SDK æœªè¼‰å…¥");
          return;
        }

        try {
          // å…ˆåˆå§‹åŒ– Google ID æœå‹™
          const clientId =
            "225638092115-2rjm7fr2me7k9k420v92m329sk6s3ho0.apps.googleusercontent.com";

          google.accounts.id.initialize({
            client_id: clientId,
            callback: (response) => {
              logTestResult("ç¨‹å¼åŒ–ç™»å…¥", "ç™»å…¥å›èª¿", response);
              processGoogleResponse(response, "ç¨‹å¼åŒ–ç™»å…¥");
            },
          });

          google.accounts.id.prompt((notification) => {
            logTestResult("ç¨‹å¼åŒ–ç™»å…¥", "æç¤ºå›èª¿", notification);
          });
        } catch (error) {
          logTestResult("ç¨‹å¼åŒ–ç™»å…¥", "éŒ¯èª¤", error.message);
        }
      }

      // å½ˆå‡ºè¦–çª—ç™»å…¥æ¸¬è©¦
      function testPopupLogin() {
        logTestResult("å½ˆå‡ºè¦–çª—ç™»å…¥", "é–‹å§‹", "å˜—è©¦é–‹å•Ÿå½ˆå‡ºè¦–çª—...");

        // ä½¿ç”¨å‚³çµ±çš„ OAuth æµç¨‹
        const clientId =
          "225638092115-2rjm7fr2me7k9k420v92m329sk6s3ho0.apps.googleusercontent.com";
        const redirectUri = encodeURIComponent(window.location.href);
        const scope = encodeURIComponent("openid email profile");

        const authUrl =
          `https://accounts.google.com/o/oauth2/v2/auth?` +
          `client_id=${clientId}&` +
          `redirect_uri=${redirectUri}&` +
          `scope=${scope}&` +
          `response_type=code&` +
          `access_type=offline&` +
          `prompt=consent`;

        const popup = window.open(
          authUrl,
          "googleAuth",
          "width=500,height=600"
        );

        if (popup) {
          logTestResult("å½ˆå‡ºè¦–çª—ç™»å…¥", "æˆåŠŸ", "å½ˆå‡ºè¦–çª—å·²é–‹å•Ÿ");
        } else {
          logTestResult("å½ˆå‡ºè¦–çª—ç™»å…¥", "å¤±æ•—", "å½ˆå‡ºè¦–çª—è¢«é˜»æ“‹");
        }
      }

      async function processGoogleResponse(response, method) {
        try {
          logTestResult(method, "è™•ç†å›æ‡‰", "ç™¼é€åˆ°å¾Œç«¯é©—è­‰...");

          const loginResponse = await fetch(
            "http://localhost:8000/auth/google/login",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                id_token: response.credential,
              }),
            }
          );

          if (!loginResponse.ok) {
            throw new Error(
              `HTTP ${loginResponse.status}: ${await loginResponse.text()}`
            );
          }

          const data = await loginResponse.json();
          logTestResult(method, "æˆåŠŸ", data);
        } catch (error) {
          logTestResult(method, "å¤±æ•—", error.message);
        }
      }

      function logTestResult(method, status, data) {
        const results = document.getElementById("testResults");
        const timestamp = new Date().toLocaleTimeString();

        const resultDiv = document.createElement("div");
        resultDiv.innerHTML = `
                <strong>[${timestamp}] ${method} - ${status}:</strong>
                <pre>${
                  typeof data === "object"
                    ? JSON.stringify(data, null, 2)
                    : data
                }</pre>
            `;

        results.appendChild(resultDiv);
        results.scrollTop = results.scrollHeight;
      }
    </script>

    <!-- è¼‰å…¥ Google Sign-In SDK -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
  </body>
</html>
