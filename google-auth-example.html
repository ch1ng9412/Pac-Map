<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Google ç™»å…¥æ¸¬è©¦</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .container {
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .login-section,
      .user-info {
        margin: 20px 0;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 5px;
      }
      .user-info {
        background-color: #e8f5e8;
      }
      .hidden {
        display: none;
      }
      .error {
        color: red;
        background-color: #ffe6e6;
        padding: 10px;
        border-radius: 5px;
        margin: 10px 0;
      }
      .success {
        color: green;
        background-color: #e6ffe6;
        padding: 10px;
        border-radius: 5px;
        margin: 10px 0;
      }
      button {
        background-color: #4285f4;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        margin: 5px;
      }
      button:hover {
        background-color: #3367d6;
      }
      .logout-btn {
        background-color: #dc3545;
      }
      .logout-btn:hover {
        background-color: #c82333;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸ® Pac-Map Google ç™»å…¥æ¸¬è©¦</h1>

      <div id="loginSection" class="login-section">
        <h2>ç™»å…¥</h2>
        <p>è«‹ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥ä»¥æ¸¬è©¦å¾Œç«¯ API</p>
        <div
          id="g_id_onload"
          data-client_id="225638092115-2rjm7fr2me7k9k420v92m329sk6s3ho0.apps.googleusercontent.com"
          data-callback="handleCredentialResponse"
          data-auto_prompt="false"
        ></div>
        <div class="g_id_signin" data-type="standard"></div>

        <div style="margin-top: 20px">
          <p><strong>è¨­å®šèªªæ˜ï¼š</strong></p>
          <ol>
            <li>
              è«‹å°‡ä¸Šæ–¹çš„ <code>YOUR_GOOGLE_CLIENT_ID</code> æ›¿æ›ç‚ºæ‚¨çš„ Google
              Client ID
            </li>
            <li>ç¢ºä¿å¾Œç«¯ä¼ºæœå™¨æ­£åœ¨é‹è¡Œ (http://localhost:8000)</li>
            <li>åœ¨ Google Cloud Console ä¸­è¨­å®šæ­£ç¢ºçš„æˆæ¬Šç¶²åŸŸ</li>
          </ol>
        </div>
      </div>

      <div id="userInfo" class="user-info hidden">
        <h2>ç”¨æˆ¶è³‡è¨Š</h2>
        <div id="userDetails"></div>
        <button onclick="logout()" class="logout-btn">ç™»å‡º</button>
        <button onclick="testAPI()">æ¸¬è©¦ API</button>
        <button onclick="submitTestScore()">æäº¤æ¸¬è©¦åˆ†æ•¸</button>
        <button onclick="getLeaderboard()">å–å¾—æ’è¡Œæ¦œ</button>
      </div>

      <div id="messages"></div>

      <div id="apiResults" style="margin-top: 20px">
        <h3>API æ¸¬è©¦çµæœ</h3>
        <pre
          id="apiOutput"
          style="
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
          "
        ></pre>
      </div>
    </div>

    <script>
      let currentUser = null;
      let accessToken = null;
      const API_BASE = "http://localhost:8000";

      // Google ç™»å…¥å›èª¿å‡½æ•¸
      function handleCredentialResponse(response) {
        console.log("Encoded JWT ID token: " + response.credential);

        // ç™¼é€ ID token åˆ°å¾Œç«¯é€²è¡Œé©—è­‰
        loginWithBackend(response.credential);
      }

      // èˆ‡å¾Œç«¯é€²è¡Œç™»å…¥
      async function loginWithBackend(idToken) {
        try {
          showMessage("æ­£åœ¨ç™»å…¥...", "info");

          const response = await fetch(`${API_BASE}/auth/google/login`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              id_token: idToken,
            }),
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();
          console.log("Login response:", data);

          // å„²å­˜ç”¨æˆ¶è³‡è¨Šå’Œ token
          currentUser = data.user;
          accessToken = data.access_token;

          // æ›´æ–° UI
          showUserInfo(currentUser);
          showMessage("ç™»å…¥æˆåŠŸï¼", "success");
        } catch (error) {
          console.error("Login error:", error);
          showMessage(`ç™»å…¥å¤±æ•—: ${error.message}`, "error");
        }
      }

      // é¡¯ç¤ºç”¨æˆ¶è³‡è¨Š
      function showUserInfo(user) {
        document.getElementById("loginSection").classList.add("hidden");
        document.getElementById("userInfo").classList.remove("hidden");

        document.getElementById("userDetails").innerHTML = `
                <p><strong>å§“å:</strong> ${user.name}</p>
                <p><strong>Email:</strong> ${user.email}</p>
                <p><strong>ç”¨æˆ¶ ID:</strong> ${user.id}</p>
                <p><strong>è¨»å†Šæ™‚é–“:</strong> ${new Date(
                  user.created_at
                ).toLocaleString()}</p>
                ${
                  user.picture
                    ? `<img src="${user.picture}" alt="é ­åƒ" style="width: 50px; height: 50px; border-radius: 50%;">`
                    : ""
                }
            `;
      }

      // ç™»å‡º
      function logout() {
        currentUser = null;
        accessToken = null;

        document.getElementById("loginSection").classList.remove("hidden");
        document.getElementById("userInfo").classList.add("hidden");

        showMessage("å·²ç™»å‡º", "info");
        clearAPIOutput();
      }

      // æ¸¬è©¦ API
      async function testAPI() {
        if (!accessToken) {
          showMessage("è«‹å…ˆç™»å…¥", "error");
          return;
        }

        try {
          const response = await fetch(`${API_BASE}/auth/me`, {
            headers: {
              Authorization: `Bearer ${accessToken}`,
            },
          });

          const data = await response.json();
          showAPIResult("GET /auth/me", data);
        } catch (error) {
          showMessage(`API æ¸¬è©¦å¤±æ•—: ${error.message}`, "error");
        }
      }

      // æäº¤æ¸¬è©¦åˆ†æ•¸
      async function submitTestScore() {
        if (!accessToken) {
          showMessage("è«‹å…ˆç™»å…¥", "error");
          return;
        }

        const testScore = {
          score: Math.floor(Math.random() * 10000) + 1000,
          level: Math.floor(Math.random() * 5) + 1,
          map_index: Math.floor(Math.random() * 3),
          survival_time: Math.floor(Math.random() * 600) + 60,
          dots_collected: Math.floor(Math.random() * 100) + 50,
          ghosts_eaten: Math.floor(Math.random() * 10),
        };

        try {
          const response = await fetch(`${API_BASE}/game/score`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${accessToken}`,
            },
            body: JSON.stringify(testScore),
          });

          const data = await response.json();
          showAPIResult("POST /game/score", {
            request: testScore,
            response: data,
          });
          showMessage("åˆ†æ•¸æäº¤æˆåŠŸï¼", "success");
        } catch (error) {
          showMessage(`åˆ†æ•¸æäº¤å¤±æ•—: ${error.message}`, "error");
        }
      }

      // å–å¾—æ’è¡Œæ¦œ
      async function getLeaderboard() {
        try {
          const response = await fetch(`${API_BASE}/game/leaderboard?limit=5`);
          const data = await response.json();
          showAPIResult("GET /game/leaderboard", data);
        } catch (error) {
          showMessage(`å–å¾—æ’è¡Œæ¦œå¤±æ•—: ${error.message}`, "error");
        }
      }

      // é¡¯ç¤ºè¨Šæ¯
      function showMessage(message, type) {
        const messagesDiv = document.getElementById("messages");
        const messageDiv = document.createElement("div");
        messageDiv.className = type;
        messageDiv.textContent = message;
        messagesDiv.appendChild(messageDiv);

        // 3ç§’å¾Œè‡ªå‹•ç§»é™¤è¨Šæ¯
        setTimeout(() => {
          messageDiv.remove();
        }, 3000);
      }

      // é¡¯ç¤º API çµæœ
      function showAPIResult(endpoint, data) {
        const output = document.getElementById("apiOutput");
        const timestamp = new Date().toLocaleTimeString();
        output.textContent += `[${timestamp}] ${endpoint}:\n${JSON.stringify(
          data,
          null,
          2
        )}\n\n`;
        output.scrollTop = output.scrollHeight;
      }

      // æ¸…é™¤ API è¼¸å‡º
      function clearAPIOutput() {
        document.getElementById("apiOutput").textContent = "";
      }

      // é é¢è¼‰å…¥æ™‚æª¢æŸ¥å¾Œç«¯ç‹€æ…‹
      window.onload = async function () {
        try {
          const response = await fetch(`${API_BASE}/health`);
          if (response.ok) {
            showMessage("å¾Œç«¯ä¼ºæœå™¨é€£ç·šæ­£å¸¸", "success");
          } else {
            showMessage("å¾Œç«¯ä¼ºæœå™¨å›æ‡‰ç•°å¸¸", "error");
          }
        } catch (error) {
          showMessage(
            "ç„¡æ³•é€£æ¥åˆ°å¾Œç«¯ä¼ºæœå™¨ï¼Œè«‹ç¢ºèªä¼ºæœå™¨æ˜¯å¦æ­£åœ¨é‹è¡Œ",
            "error"
          );
        }
      };
    </script>
  </body>
</html>
