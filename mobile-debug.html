<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰‹æ©Ÿé™¤éŒ¯é é¢</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 15px;
            background: #000;
            color: #fff;
            font-size: 14px;
            line-height: 1.4;
        }
        .section {
            margin: 15px 0;
            padding: 10px;
            border: 1px solid #333;
            border-radius: 5px;
            background: #111;
        }
        .title {
            color: #ffff00;
            font-weight: bold;
            margin-bottom: 8px;
        }
        .info {
            color: #0ff;
            margin: 3px 0;
            word-break: break-all;
        }
        .success {
            color: #0f0;
        }
        .error {
            color: #f00;
        }
        .warning {
            color: #ff0;
        }
        button {
            background: #2121de;
            color: #ffff00;
            border: 2px solid #000;
            padding: 8px 12px;
            margin: 5px 2px;
            cursor: pointer;
            border-radius: 3px;
            font-size: 12px;
        }
        button:active {
            background: #4242ff;
        }
        .test-result {
            margin: 8px 0;
            padding: 8px;
            background: #222;
            border-radius: 3px;
            font-family: monospace;
            font-size: 11px;
        }
        .big-button {
            width: 100%;
            padding: 12px;
            font-size: 14px;
            margin: 8px 0;
        }
    </style>
</head>
<body>
    <h1>ğŸ“± æ‰‹æ©Ÿé™¤éŒ¯é é¢</h1>
    
    <div class="section">
        <div class="title">ğŸŒ ç•¶å‰ç’°å¢ƒè³‡è¨Š</div>
        <div class="info" id="currentUrl">è¼‰å…¥ä¸­...</div>
        <div class="info" id="hostname">è¼‰å…¥ä¸­...</div>
        <div class="info" id="protocol">è¼‰å…¥ä¸­...</div>
        <div class="info" id="port">è¼‰å…¥ä¸­...</div>
        <div class="info" id="userAgent">è¼‰å…¥ä¸­...</div>
    </div>

    <div class="section">
        <div class="title">âš™ï¸ é…ç½®æª¢æ¸¬çµæœ</div>
        <div class="info" id="isDevelopment">è¼‰å…¥ä¸­...</div>
        <div class="info" id="isLocalFile">è¼‰å…¥ä¸­...</div>
        <div class="info" id="apiBaseUrl">è¼‰å…¥ä¸­...</div>
        <div class="info" id="configStatus">è¼‰å…¥ä¸­...</div>
    </div>

    <div class="section">
        <div class="title">ğŸ”— API é€£ç·šæ¸¬è©¦</div>
        <button class="big-button" onclick="testApiConnection()">æ¸¬è©¦ API é€£ç·š</button>
        <div class="test-result" id="apiTestResult">é»æ“ŠæŒ‰éˆ•é–‹å§‹æ¸¬è©¦</div>
    </div>

    <div class="section">
        <div class="title">ğŸ® éŠæˆ²åŠŸèƒ½æ¸¬è©¦</div>
        <button onclick="testLeaderboard()">æ¸¬è©¦æ’è¡Œæ¦œ</button>
        <button onclick="testAuth()">æ¸¬è©¦èªè­‰</button>
        <button onclick="testScore()">æ¸¬è©¦åˆ†æ•¸æäº¤</button>
        <div class="test-result" id="gameTestResult">é¸æ“‡åŠŸèƒ½é€²è¡Œæ¸¬è©¦</div>
    </div>

    <div class="section">
        <div class="title">ğŸ”§ æ‰‹å‹•ä¿®å¾©</div>
        <button onclick="forceApiUrl()">å¼·åˆ¶è¨­å®š API åœ°å€</button>
        <button onclick="clearCache()">æ¸…é™¤å¿«å–</button>
        <button onclick="reloadPage()">é‡æ–°è¼‰å…¥é é¢</button>
        <div class="test-result" id="fixResult">æ‰‹å‹•ä¿®å¾©é¸é …</div>
    </div>

    <script type="module">
        // è¼‰å…¥é…ç½®æ¨¡çµ„
        let config, buildApiUrl, checkBackendConnection;
        
        try {
            const configModule = await import('./js/config.js');
            config = configModule.config;
            buildApiUrl = configModule.buildApiUrl;
            checkBackendConnection = configModule.checkBackendConnection;
        } catch (error) {
            console.error('è¼‰å…¥é…ç½®æ¨¡çµ„å¤±æ•—:', error);
        }

        // é¡¯ç¤ºç’°å¢ƒè³‡è¨Š
        function showEnvironmentInfo() {
            document.getElementById('currentUrl').textContent = `å®Œæ•´ URL: ${window.location.href}`;
            document.getElementById('hostname').textContent = `ä¸»æ©Ÿå: ${window.location.hostname}`;
            document.getElementById('protocol').textContent = `å”å®š: ${window.location.protocol}`;
            document.getElementById('port').textContent = `åŸ å£: ${window.location.port || 'é è¨­'}`;
            document.getElementById('userAgent').textContent = `User Agent: ${navigator.userAgent.substring(0, 80)}...`;
        }

        // é¡¯ç¤ºé…ç½®è³‡è¨Š
        function showConfigInfo() {
            if (!config) {
                document.getElementById('configStatus').innerHTML = '<span class="error">âŒ é…ç½®æ¨¡çµ„è¼‰å…¥å¤±æ•—</span>';
                return;
            }

            const isDev = config.environment.isDevelopment;
            const isLocal = config.environment.isLocalFile;
            const apiUrl = config.api.baseUrl;

            document.getElementById('isDevelopment').innerHTML = `é–‹ç™¼ç’°å¢ƒ: <span class="${isDev ? 'warning' : 'info'}">${isDev ? 'æ˜¯' : 'å¦'}</span>`;
            document.getElementById('isLocalFile').innerHTML = `æœ¬åœ°æª”æ¡ˆ: <span class="${isLocal ? 'warning' : 'info'}">${isLocal ? 'æ˜¯' : 'å¦'}</span>`;
            document.getElementById('apiBaseUrl').innerHTML = `API åœ°å€: <span class="info">${apiUrl}</span>`;
            document.getElementById('configStatus').innerHTML = '<span class="success">âœ… é…ç½®è¼‰å…¥æˆåŠŸ</span>';
        }

        // æ¸¬è©¦ API é€£ç·š
        async function testApiConnection() {
            const resultDiv = document.getElementById('apiTestResult');
            resultDiv.innerHTML = '<span class="info">ğŸ”„ æ­£åœ¨æ¸¬è©¦ API é€£ç·š...</span>';

            if (!buildApiUrl) {
                resultDiv.innerHTML = '<span class="error">âŒ é…ç½®æ¨¡çµ„æœªè¼‰å…¥</span>';
                return;
            }

            const apiUrl = buildApiUrl('/health');
            resultDiv.innerHTML += `<br>æ¸¬è©¦åœ°å€: ${apiUrl}`;

            try {
                const startTime = Date.now();
                const response = await fetch(apiUrl);
                const endTime = Date.now();
                const duration = endTime - startTime;

                if (response.ok) {
                    const data = await response.json();
                    resultDiv.innerHTML = `
                        <span class="success">âœ… API é€£ç·šæˆåŠŸ</span><br>
                        åœ°å€: ${apiUrl}<br>
                        å›æ‡‰æ™‚é–“: ${duration}ms<br>
                        ç‹€æ…‹: ${response.status}<br>
                        è³‡æ–™: ${JSON.stringify(data)}
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <span class="error">âŒ API å›æ‡‰éŒ¯èª¤</span><br>
                        åœ°å€: ${apiUrl}<br>
                        ç‹€æ…‹ç¢¼: ${response.status}<br>
                        ç‹€æ…‹æ–‡å­—: ${response.statusText}
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <span class="error">âŒ API é€£ç·šå¤±æ•—</span><br>
                    åœ°å€: ${apiUrl}<br>
                    éŒ¯èª¤: ${error.message}<br>
                    é¡å‹: ${error.name}
                `;
            }
        }

        // æ¸¬è©¦æ’è¡Œæ¦œ
        async function testLeaderboard() {
            const resultDiv = document.getElementById('gameTestResult');
            resultDiv.innerHTML = '<span class="info">ğŸ”„ æ¸¬è©¦æ’è¡Œæ¦œ...</span>';

            try {
                const apiUrl = buildApiUrl('/game/leaderboard?limit=3');
                const response = await fetch(apiUrl);
                
                if (response.ok) {
                    const data = await response.json();
                    resultDiv.innerHTML = `
                        <span class="success">âœ… æ’è¡Œæ¦œæ¸¬è©¦æˆåŠŸ</span><br>
                        è¨˜éŒ„æ•¸é‡: ${data.data ? data.data.length : 0}<br>
                        è³‡æ–™: ${JSON.stringify(data).substring(0, 200)}...
                    `;
                } else {
                    resultDiv.innerHTML = `<span class="error">âŒ æ’è¡Œæ¦œæ¸¬è©¦å¤±æ•—: ${response.status}</span>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<span class="error">âŒ æ’è¡Œæ¦œæ¸¬è©¦éŒ¯èª¤: ${error.message}</span>`;
            }
        }

        // æ¸¬è©¦èªè­‰
        async function testAuth() {
            const resultDiv = document.getElementById('gameTestResult');
            resultDiv.innerHTML = '<span class="info">ğŸ”„ æ¸¬è©¦èªè­‰...</span>';

            try {
                const apiUrl = buildApiUrl('/auth/me');
                const response = await fetch(apiUrl);
                
                resultDiv.innerHTML = `
                    <span class="${response.ok ? 'success' : 'warning'}">
                        ${response.ok ? 'âœ…' : 'âš ï¸'} èªè­‰æ¸¬è©¦å®Œæˆ
                    </span><br>
                    ç‹€æ…‹: ${response.status}<br>
                    ${response.status === 401 ? '(æœªç™»å…¥ç‹€æ…‹ï¼Œé€™æ˜¯æ­£å¸¸çš„)' : ''}
                `;
            } catch (error) {
                resultDiv.innerHTML = `<span class="error">âŒ èªè­‰æ¸¬è©¦éŒ¯èª¤: ${error.message}</span>`;
            }
        }

        // æ¸¬è©¦åˆ†æ•¸æäº¤
        async function testScore() {
            const resultDiv = document.getElementById('gameTestResult');
            resultDiv.innerHTML = '<span class="warning">âš ï¸ åˆ†æ•¸æäº¤éœ€è¦ç™»å…¥ï¼Œé€™è£¡åªæ¸¬è©¦ç«¯é»å¯é”æ€§</span>';

            try {
                const apiUrl = buildApiUrl('/game/score');
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ test: true })
                });
                
                resultDiv.innerHTML += `<br><span class="info">åˆ†æ•¸ç«¯é»ç‹€æ…‹: ${response.status}</span>`;
            } catch (error) {
                resultDiv.innerHTML += `<br><span class="error">åˆ†æ•¸ç«¯é»éŒ¯èª¤: ${error.message}</span>`;
            }
        }

        // å¼·åˆ¶è¨­å®š API åœ°å€
        function forceApiUrl() {
            const currentHost = window.location.hostname;
            const newApiUrl = `${window.location.protocol}//${currentHost}:8000`;
            
            if (config) {
                config.api.baseUrl = newApiUrl;
                document.getElementById('fixResult').innerHTML = `
                    <span class="success">âœ… API åœ°å€å·²å¼·åˆ¶è¨­å®šç‚º:</span><br>
                    ${newApiUrl}<br>
                    <span class="info">è«‹é‡æ–°æ¸¬è©¦ API é€£ç·š</span>
                `;
                
                // æ›´æ–°é¡¯ç¤º
                showConfigInfo();
            } else {
                document.getElementById('fixResult').innerHTML = '<span class="error">âŒ é…ç½®ç‰©ä»¶ä¸å­˜åœ¨</span>';
            }
        }

        // æ¸…é™¤å¿«å–
        function clearCache() {
            try {
                localStorage.clear();
                sessionStorage.clear();
                document.getElementById('fixResult').innerHTML = '<span class="success">âœ… æœ¬åœ°å¿«å–å·²æ¸…é™¤</span>';
            } catch (error) {
                document.getElementById('fixResult').innerHTML = `<span class="error">âŒ æ¸…é™¤å¿«å–å¤±æ•—: ${error.message}</span>`;
            }
        }

        // é‡æ–°è¼‰å…¥é é¢
        function reloadPage() {
            window.location.reload(true);
        }

        // æš´éœ²å‡½æ•¸åˆ°å…¨åŸŸ
        window.testApiConnection = testApiConnection;
        window.testLeaderboard = testLeaderboard;
        window.testAuth = testAuth;
        window.testScore = testScore;
        window.forceApiUrl = forceApiUrl;
        window.clearCache = clearCache;
        window.reloadPage = reloadPage;

        // é é¢è¼‰å…¥æ™‚åŸ·è¡Œ
        window.addEventListener('load', () => {
            showEnvironmentInfo();
            showConfigInfo();
        });
    </script>
</body>
</html>
