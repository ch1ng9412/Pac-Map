# 🎮 Pac-Map 分數整合系統實作指南

## 📋 功能概述

本次實作為 Pac-Map 遊戲添加了完整的分數管理系統，支援登入用戶的雲端分數記錄和未登入用戶的本地分數管理。

## 🎯 實作的功能

### 1. 📱 本地分數管理
- **本地分數保存**：未登入用戶的分數自動保存到 localStorage
- **本地排行榜**：顯示個人最佳記錄（最多保留 20 筆）
- **數據結構**：包含分數、等級、地圖、存活時間、收集點數、吃鬼數量等詳細資訊

### 2. 🌐 後端分數提交
- **自動提交**：登入用戶遊戲結束時自動提交分數到後端
- **錯誤處理**：網路失敗時自動保存到本地作為備份
- **認證整合**：使用 JWT token 進行安全的 API 調用

### 3. 🎨 差異化遊戲體驗
- **登入用戶**：分數直接提交到雲端，參與全球排行榜
- **未登入用戶**：分數保存在本地，高分時提示登入
- **漸進式引導**：通過成就感自然引導用戶登入

### 4. 🔄 數據遷移系統
- **自動檢測**：用戶登入後自動檢測本地分數記錄
- **遷移提示**：友善的對話框讓用戶選擇是否同步
- **批量上傳**：支援一次性同步所有本地記錄

### 5. 📊 混合排行榜顯示
- **全球排行榜**：顯示來自後端的全球玩家記錄
- **本地記錄**：未登入用戶可查看個人歷史記錄
- **視覺區分**：不同顏色和標籤區分全球和本地記錄

## 🛠️ 技術實作細節

### 修改的檔案

#### `js/game.js`
- 添加本地分數管理函數
- 實作後端分數提交功能
- 修改 `endGame()` 函數支援差異化處理
- 添加登入提示和遷移功能
- 追蹤 `ghostsEaten` 統計

#### `js/auth.js`
- 添加登入後數據遷移檢測
- 實作遷移對話框和批量上傳
- 改善錯誤處理和用戶回饋

#### `js/ui.js`
- 實作混合排行榜顯示
- 支援全球和本地記錄的整合顯示
- 添加登入提示元素

#### `js/gameState.js`
- 添加 `ghostsEaten` 統計欄位

#### `index.html`
- 添加本地記錄和遷移提示的 CSS 樣式

### 新增的功能函數

#### 本地分數管理
```javascript
getLocalScores()           // 獲取本地分數記錄
saveLocalScore(scoreData)  // 保存分數到本地
clearLocalScores()         // 清除本地記錄
```

#### 後端整合
```javascript
submitScoreToBackend(scoreData)  // 提交分數到後端
showScoreSubmissionError(msg)    // 顯示提交錯誤
```

#### 遷移系統
```javascript
checkAndOfferLocalScoreMigration()  // 檢查並提供遷移
startMigration()                    // 開始遷移流程
```

## 🎮 用戶體驗流程

### 未登入用戶
1. 正常遊戲，分數自動保存到本地
2. 可查看個人本地排行榜
3. 高分時顯示登入激勵提示
4. 登入後可選擇同步本地記錄

### 登入用戶
1. 遊戲結束時分數自動提交到後端
2. 參與全球排行榜競爭
3. 可查看詳細的遊戲統計
4. 跨設備同步遊戲記錄

## 🧪 測試方法

### 1. 使用測試頁面
開啟 `test-score-integration.html` 進行功能測試：
- 本地分數保存和讀取
- 後端連線和 API 測試
- 認證狀態模擬
- 整合功能驗證

### 2. 手動測試流程
1. **未登入測試**：
   - 開始遊戲並結束
   - 檢查本地分數是否保存
   - 查看排行榜顯示

2. **登入測試**：
   - 登入 Google 帳戶
   - 開始遊戲並結束
   - 確認分數提交到後端

3. **遷移測試**：
   - 先以未登入狀態玩幾局
   - 然後登入
   - 檢查是否出現遷移提示

## 🔧 設定需求

### 後端設定
1. 確保後端伺服器運行：
   ```bash
   cd backend
   uv run start_server.py
   ```

2. 檢查 Google OAuth 設定（參考 `backend/GOOGLE_OAUTH_SETUP.md`）

### 前端設定
1. 確保所有 JavaScript 模組正確載入
2. 檢查 API 端點 URL 設定
3. 測試 localStorage 功能

## 🚀 部署注意事項

### 生產環境
1. **安全性**：
   - 更改 JWT Secret Key
   - 實作 API 速率限制
   - 添加分數驗證機制

2. **效能**：
   - 實作排行榜快取
   - 優化資料庫查詢
   - 添加 CDN 支援

3. **監控**：
   - 添加錯誤追蹤
   - 實作使用統計
   - 設定健康檢查

## 📈 未來改進方向

1. **分數驗證**：實作防作弊機制
2. **社交功能**：好友排行榜、分享功能
3. **成就系統**：遊戲成就和徽章
4. **數據分析**：詳細的遊戲統計和分析
5. **離線支援**：Service Worker 和離線遊戲

## 🎉 總結

本次實作成功建立了完整的分數管理生態系統，為 Pac-Map 遊戲提供了：
- 無縫的用戶體驗（登入/未登入都能正常遊戲）
- 強大的數據管理（本地+雲端雙重保障）
- 智慧的引導機制（自然激勵用戶登入）
- 完善的遷移系統（數據不丟失）

這個系統為遊戲的長期發展奠定了堅實的基礎，同時保持了良好的用戶體驗和技術可維護性。
